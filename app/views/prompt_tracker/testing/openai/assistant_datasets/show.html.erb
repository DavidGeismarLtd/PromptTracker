<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "OpenAI Assistants", testing_openai_assistants_path %></li>
  <li class="breadcrumb-item"><%= link_to @assistant.name, testing_openai_assistant_path(@assistant) %></li>
  <li class="breadcrumb-item"><%= link_to "Datasets", testing_openai_assistant_datasets_path(@assistant) %></li>
  <li class="breadcrumb-item active"><%= @dataset.name %></li>
<% end %>

<!-- Subscribe to Turbo Stream for real-time row updates -->
<%= turbo_stream_from "dataset_#{@dataset.id}_rows" %>

<div class="page-header" style="background-color: #EFF6FF; border-left: 4px solid #3B82F6; padding: 1.5rem; margin-bottom: 2rem;">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h1 style="color: #1E40AF; margin: 0;">
        <i class="bi bi-database"></i> <%= @dataset.name %>
      </h1>
      <% if @dataset.description.present? %>
        <p style="color: #1E40AF; margin: 0.5rem 0 0 0;"><%= @dataset.description %></p>
      <% end %>
    </div>
    <div class="d-flex gap-2">
      <%= link_to testing_openai_assistant_datasets_path(@assistant), class: "btn btn-outline-primary" do %>
        <i class="bi bi-arrow-left"></i> Back to Datasets
      <% end %>
      <%= link_to edit_testing_openai_assistant_dataset_path(@assistant, @dataset), class: "btn btn-outline-secondary" do %>
        <i class="bi bi-pencil"></i> Edit
      <% end %>
    </div>
  </div>
</div>

<!-- Add Row Section -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add Rows</h5>
  </div>
  <div class="card-body">
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRowModal">
        <i class="bi bi-plus-circle"></i> Add Row Manually
      </button>
      <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#generateRowsModal">
        <i class="bi bi-stars"></i> Generate with AI
      </button>
    </div>

    <!-- Generation Status (updated via Turbo Streams) -->
    <div id="generation-status" class="mt-3">
      <!-- Status messages will appear here -->
    </div>
  </div>
</div>

<!-- Rows Table -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-table"></i> Dataset Rows (<span id="dataset-row-count"><%= @dataset.row_count %></span>)</h5>
  </div>
  <div class="card-body" id="rows-table-container">
    <% if @rows.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>User Prompt</th>
              <th>Max Turns</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="dataset-rows">
            <% @rows.each do |row| %>
              <tr id="dataset-row-<%= row.id %>">
                <td>
                  <div style="max-width: 500px; overflow: hidden; text-overflow: ellipsis;">
                    <%= row.row_data["user_prompt"] %>
                  </div>
                </td>
                <td>
                  <span class="badge bg-secondary"><%= row.row_data["max_turns"] || 3 %></span>
                </td>
                <td>
                  <%= button_to testing_openai_assistant_dataset_dataset_row_path(@assistant, @dataset, row),
                                method: :delete,
                                class: "btn btn-sm btn-outline-danger",
                                data: { confirm: "Are you sure?" } do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-3">
        <%= paginate @rows %>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-table" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No rows yet. Add rows manually or generate them with AI.</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Modals with fix controller -->
<div data-controller="modal-fix">
  <!-- Add Row Modal -->
  <div class="modal fade" id="addRowModal" tabindex="-1" data-modal-fix-target="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Row</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <%= form_with url: testing_openai_assistant_dataset_dataset_rows_path(@assistant, @dataset), method: :post do |f| %>
          <div class="modal-body">
            <div class="mb-3">
              <%= label_tag "row_data[user_prompt]", "User Prompt", class: "form-label" %>
              <%= text_area_tag "row_data[user_prompt]", "", class: "form-control", rows: 3, required: true, placeholder: "Enter the initial user message..." %>
            </div>
            <div class="mb-3">
              <%= label_tag "row_data[max_turns]", "Max Turns", class: "form-label" %>
              <%= number_field_tag "row_data[max_turns]", 3, class: "form-control", min: 1, max: 20 %>
              <div class="form-text">Maximum number of conversation turns (1-20)</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Add Row", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Generate Rows Modal -->
  <div class="modal fade" id="generateRowsModal" tabindex="-1" data-modal-fix-target="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Generate Rows with AI</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <%= form_with url: generate_rows_testing_openai_assistant_dataset_path(@assistant, @dataset), method: :post do |f| %>
          <div class="modal-body">
            <div class="mb-3">
              <%= f.label :count, "Number of Rows", class: "form-label" %>
              <%= f.number_field :count, class: "form-control", value: 5, min: 1, max: 50 %>
            </div>
            <div class="mb-3">
              <%= f.label :instructions, "Instructions", class: "form-label" %>
              <%= f.text_area :instructions, class: "form-control", rows: 4, placeholder: "Generate conversation scenarios for testing customer support..." %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Generate", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
