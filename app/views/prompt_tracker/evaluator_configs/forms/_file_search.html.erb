<%# Form for File Search Evaluator - validates that assistant searched expected files %>
<% existing_config ||= nil %>
<% config = existing_config&.config || {} %>
<% evaluator_key ||= 'file_search' %>
<% namespace ||= 'config' %>
<% testable ||= nil %>
<% expected_files = config['expected_files'] || config[:expected_files] || [] %>
<% expected_files = expected_files.is_a?(Array) ? expected_files : expected_files.to_s.split("\n").map(&:strip).reject(&:empty?) %>
<% require_all = config.key?('require_all') ? config['require_all'] : (config.key?(:require_all) ? config[:require_all] : true) %>
<% threshold_score = config['threshold_score'] || config[:threshold_score] || 100 %>

<%
  # Get files from the vector store(s)
  vector_store_files = []
  vector_store_ids = []

  if testable.is_a?(PromptTracker::Openai::Assistant)
    # Assistants store vector stores in metadata.tool_resources
    vector_store_ids = testable.metadata&.dig("tool_resources", "file_search", "vector_store_ids") || []
  elsif testable.is_a?(PromptTracker::PromptVersion)
    # PromptVersions store vector stores in model_config.tool_config (for Responses API)
    vector_store_ids = testable.model_config&.dig("tool_config", "file_search", "vector_store_ids") || []
  end

  if vector_store_ids.present?
    service = PromptTracker::AssistantPlaygroundService.new
    vector_store_ids.each do |vs_id|
      result = service.list_vector_store_files(vector_store_id: vs_id)
      vector_store_files.concat(result[:files]) if result[:success]
    end
  end
%>

<div class="alert alert-info mb-3">
  <i class="bi bi-file-earmark-search"></i>
  <strong>File Search Evaluator</strong>
  <p class="mb-0 mt-1">Verifies that the assistant searched within the expected files during the conversation.</p>
</div>

<!-- Hidden fields for evaluator type and context -->
<input type="hidden" name="evaluation[evaluator_type]" value="automated">
<input type="hidden" name="evaluation[evaluator_id]" value="<%= evaluator_key %>">
<input type="hidden" name="evaluation[evaluation_context]" value="manual">

<!-- Expected Files -->
<div class="mb-3">
  <label class="form-label">Expected Files</label>
  <% if vector_store_files.any? %>
    <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
      <% vector_store_files.each do |file| %>
        <div class="form-check">
          <input class="form-check-input file-search-file-checkbox"
                 type="checkbox"
                 value="<%= file[:filename] %>"
                 id="file_<%= file[:id] %>"
                 data-file-id="<%= file[:id] %>"
                 <%= 'checked' if expected_files.include?(file[:filename]) %>>
          <label class="form-check-label" for="file_<%= file[:id] %>">
            <i class="bi bi-file-earmark"></i> <%= file[:filename] %>
            <small class="text-muted">(<%= number_to_human_size(file[:bytes]) rescue "#{file[:bytes]} bytes" %>)</small>
          </label>
        </div>
      <% end %>
    </div>
    <input type="hidden"
           name="<%= namespace %>[expected_files]"
           id="<%= evaluator_key %>_expected_files"
           value="<%= expected_files.join("\n") %>">
    <small class="form-text text-muted">
      Select the files the assistant should search during the conversation.
    </small>
    <script>
      // Update hidden field when checkboxes change
      document.querySelectorAll('.file-search-file-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          var selectedFiles = [];
          document.querySelectorAll('.file-search-file-checkbox:checked').forEach(function(cb) {
            selectedFiles.push(cb.value);
          });
          document.getElementById('<%= evaluator_key %>_expected_files').value = selectedFiles.join('\n');
        });
      });
    </script>
  <% else %>
    <div class="alert alert-warning mb-0">
      <i class="bi bi-exclamation-triangle"></i> No files found in the vector store.
      Please upload files to the assistant's vector store first.
    </div>
  <% end %>
</div>

<!-- Require All -->
<div class="mb-3">
  <div class="form-check">
    <input type="hidden" name="<%= namespace %>[require_all]" value="false">
    <input type="checkbox"
           class="form-check-input"
           name="<%= namespace %>[require_all]"
           value="true"
           id="<%= evaluator_key %>_require_all"
           <%= 'checked' if require_all %>>
    <label class="form-check-label" for="<%= evaluator_key %>_require_all">
      Require all files to be searched
    </label>
  </div>
  <small class="form-text text-muted">
    When checked, all expected files must be searched to pass. When unchecked, at least one file must be searched.
  </small>
</div>

<!-- Threshold Score -->
<div class="mb-3">
  <label class="form-label">Threshold Score (0-100)</label>
  <input type="number"
         name="<%= namespace %>[threshold_score]"
         class="form-control"
         value="<%= threshold_score %>"
         min="0"
         max="100"
         required>
  <small class="form-text text-muted">
    The minimum percentage of expected files that must be searched. Score = (matched files / expected files) * 100.
  </small>
</div>

<div class="alert alert-secondary">
  <strong>How it works:</strong>
  <ul class="mb-0 mt-2">
    <li>The evaluator analyzes the assistant's run steps to find file_search tool calls</li>
    <li>It matches the files that were searched against your expected files list</li>
    <li>Matching is case-insensitive and supports partial matches</li>
    <li>Score = percentage of expected files that were searched</li>
    <li>Pass/fail depends on whether "require all" is checked and the threshold score</li>
  </ul>
</div>
