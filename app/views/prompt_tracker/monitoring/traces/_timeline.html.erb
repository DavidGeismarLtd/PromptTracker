<div class="timeline-container">
  <% if root_spans.any? || orphan_generations.any? %>
    <div class="timeline">
      <!-- Root-level spans -->
      <% root_spans.each do |span| %>
        <%= render "prompt_tracker/monitoring/traces/span_item", span: span, level: 0 %>
      <% end %>

      <!-- Orphan generations (not in any span) -->
      <% orphan_generations.each do |generation| %>
        <%= render "prompt_tracker/monitoring/traces/generation_item", generation: generation, level: 0 %>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-5">
      <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
      <p class="text-muted mt-3">No spans or generations in this trace</p>
    </div>
  <% end %>
</div>

<style>
  .timeline-container {
    position: relative;
  }

  .timeline-item {
    position: relative;
    padding-left: 30px;
    margin-bottom: 15px;
  }

  .timeline-item::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: -15px;
    width: 2px;
    background: #dee2e6;
  }

  .timeline-item:last-child::before {
    bottom: 50%;
  }

  .timeline-item::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 10px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #fff;
    border: 2px solid #0d6efd;
  }

  .timeline-item.span-item::after {
    border-color: #0d6efd;
    background: #0d6efd;
  }

  .timeline-item.generation-item::after {
    border-color: #198754;
    background: #198754;
  }

  .timeline-item.error::after {
    border-color: #dc3545;
    background: #dc3545;
  }

  .timeline-content {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
  }

  .timeline-content.error {
    border-color: #dc3545;
    background: #f8d7da;
  }

  .nested-timeline {
    margin-left: 20px;
    margin-top: 10px;
  }

  .toggle-span {
    cursor: pointer;
    transition: transform 0.2s;
  }

  .toggle-span.collapsed .expand-icon {
    transform: rotate(-90deg);
  }

  .nested-timeline.collapsed {
    display: none;
  }
</style>

<script>
  function toggleSpan(spanId) {
    const button = document.querySelector(`[data-target="${spanId}"]`);
    const children = document.getElementById(`${spanId}-children`);

    if (children) {
      children.classList.toggle('collapsed');
      button.classList.toggle('collapsed');
    }
  }

  function expandAll() {
    document.querySelectorAll('.nested-timeline').forEach(el => {
      el.classList.remove('collapsed');
    });
    document.querySelectorAll('.toggle-span').forEach(el => {
      el.classList.remove('collapsed');
    });
  }

  function collapseAll() {
    document.querySelectorAll('.nested-timeline').forEach(el => {
      el.classList.add('collapsed');
    });
    document.querySelectorAll('.toggle-span').forEach(el => {
      el.classList.add('collapsed');
    });
  }
</script>
