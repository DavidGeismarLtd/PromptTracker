<%# Unified output messages cell - displays messages from output_data %>
<%# Clickable preview of first 2-3 messages, opens modal with full conversation %>
<td data-column="output_messages">
  <% if run.status == 'running' %>
    <%= render "prompt_tracker/testing/test_runs/cells/loading_dots" %>
  <% else %>
  <% messages = run.output_data&.dig("messages") || [] %>

  <% if messages.any? %>
    <% modal_id = "conversation-modal-#{run.id}" %>
    <% preview_messages = messages.first(3) %>

    <!-- Clickable preview -->
    <div style="cursor: pointer;"
         class="hover-highlight rounded p-1"
         data-bs-toggle="modal"
         data-bs-target="#<%= modal_id %>">

      <% preview_messages.each do |message| %>
        <div class="mb-1 d-flex align-items-start gap-1">
          <span class="badge <%= message['role'] == 'user' ? 'bg-primary' : 'bg-success' %>" style="font-size: 0.65rem;">
            <%= message['role'] == 'user' ? 'U' : 'A' %>
          </span>
          <small class="text-muted" style="line-height: 1.3;"><%= truncate(message['content'], length: 60) %></small>
        </div>
      <% end %>

      <% if messages.length > 3 %>
        <small class="text-primary">
          <i class="bi bi-three-dots"></i> +<%= messages.length - 3 %> more
        </small>
      <% end %>
    </div>

    <!-- Modal with full conversation -->
    <div data-controller="modal-fix">
      <div class="modal fade"
           id="<%= modal_id %>"
           tabindex="-1"
           aria-labelledby="<%= modal_id %>-label"
           aria-hidden="true"
           data-modal-fix-target="modal">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="<%= modal_id %>-label">
                <i class="bi bi-chat-dots"></i> Conversation (<%= messages.length %> messages)
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
              <% messages.each_with_index do |message, index| %>
                <div class="mb-3 <%= message['role'] == 'user' ? 'text-end' : '' %>">
                  <div class="d-inline-block text-start" style="max-width: 80%;">
                    <div class="mb-1">
                      <span class="badge <%= message['role'] == 'user' ? 'bg-primary' : 'bg-success' %>">
                        <%= message['role'] == 'user' ? 'User' : 'Assistant' %>
                      </span>
                      <small class="text-muted">Turn <%= (index / 2.0).ceil %></small>
                    </div>
                    <div class="p-2 rounded <%= message['role'] == 'user' ? 'bg-primary text-white' : 'bg-light' %>">
                      <%= simple_format(message['content']) %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <span class="text-muted">-</span>
  <% end %>
  <% end %>
</td>
