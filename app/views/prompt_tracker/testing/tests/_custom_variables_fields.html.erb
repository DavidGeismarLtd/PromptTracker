<!-- Custom Variables Fields -->
<!-- Renders dynamic form fields based on testable's variables_schema -->
<%
  # Local variables expected:
  # - testable: The testable object (Assistant or PromptVersion) with variables_schema method
  # - test: (optional) The test object to check for conversational mode
  # - test_mode: (optional) Explicit test mode ("single_turn" or "conversational") for run_all mode
  # - context_description: Optional description text (e.g., "Enter values for the test scenario:")
  #
  # Determine if conversational: check explicit test_mode first, then test object
  is_conversational = local_assigns[:test_mode]&.to_s == "conversational" || local_assigns[:test]&.conversational?
%>

<%# Show conversational-specific fields if test is conversational %>
<% if is_conversational %>
  <div class="mb-4 p-3 bg-light rounded border">
    <h6 class="mb-3"><i class="bi bi-chat-dots"></i> Conversation Settings</h6>

    <div class="mb-3">
      <%= label_tag "custom_variables[interlocutor_simulation_prompt]", "Interlocutor Simulation Prompt", class: "form-label" %>
      <span class="text-danger">*</span>
      <%= text_area_tag "custom_variables[interlocutor_simulation_prompt]", nil,
          class: "form-control",
          rows: 6,
          data: { required: "true" },
          placeholder: "You are simulating a user who has a specific goal or problem. Describe their behavior, personality, and objectives..." %>
      <small class="form-text text-muted">
        Describe how the simulated user should behave in the conversation. This prompt guides the LLM that plays the user role.
      </small>
    </div>

    <div class="mb-3">
      <%= label_tag "custom_variables[max_turns]", "Max Turns", class: "form-label" %>
      <%= number_field_tag "custom_variables[max_turns]", 5,
          class: "form-control",
          min: 1,
          max: 20,
          style: "max-width: 120px;" %>
      <small class="form-text text-muted">Maximum number of conversation turns (1-20, default: 5)</small>
    </div>
  </div>
<% end %>

<% if testable.variables_schema.present? %>
  <% if local_assigns[:context_description].present? %>
    <p class="text-muted mb-3">
      <%= context_description %>
    </p>
  <% end %>

  <% testable.variables_schema.each do |var_config| %>
    <% var_name = var_config["name"] %>
    <% is_required = var_config["required"] %>
    <div class="mb-3">
      <%= label_tag "custom_variables[#{var_name}]", var_name.to_s.humanize, class: "form-label" %>
      <% if is_required %>
        <span class="text-danger">*</span>
      <% end %>

      <% if var_config["type"] == "text" %>
        <%= text_area_tag "custom_variables[#{var_name}]",
            nil,
            class: "form-control",
            rows: 4,
            data: { required: is_required.to_s },
            placeholder: var_config["description"] %>
      <% elsif var_config["type"] == "integer" %>
        <%= number_field_tag "custom_variables[#{var_name}]",
            nil,
            class: "form-control",
            data: { required: is_required.to_s },
            placeholder: var_config["description"] %>
      <% else %>
        <%= text_field_tag "custom_variables[#{var_name}]",
            nil,
            class: "form-control",
            data: { required: is_required.to_s },
            placeholder: var_config["description"] %>
      <% end %>

      <% if var_config["description"].present? %>
        <small class="form-text text-muted"><%= var_config["description"] %></small>
      <% end %>
    </div>
  <% end %>
<% elsif !is_conversational %>
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    This <%= testable.class.name.demodulize.underscore.humanize.downcase %> has no variables defined.
  </div>
<% end %>
