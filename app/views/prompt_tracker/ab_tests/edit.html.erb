<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "A/B Tests", ab_tests_path %></li>
  <li class="breadcrumb-item"><%= link_to @ab_test.name, ab_test_path(@ab_test) %></li>
  <li class="breadcrumb-item active">Edit</li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1><i class="bi bi-pencil"></i> Edit A/B Test</h1>
    <p class="text-muted">Modify <%= @ab_test.name %> configuration</p>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <%= form_with model: @ab_test, url: ab_test_path(@ab_test), method: :patch, local: true do |f| %>
      <% if @ab_test.errors.any? %>
        <div class="alert alert-danger">
          <h5>Please fix the following errors:</h5>
          <ul class="mb-0">
            <% @ab_test.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Basic Info -->
      <div class="mb-4">
        <h5>Basic Information</h5>
        
        <div class="mb-3">
          <%= f.label :name, "Test Name", class: "form-label" %>
          <%= f.text_field :name, class: "form-control" %>
        </div>

        <div class="mb-3">
          <%= f.label :description, "Description (optional)", class: "form-label" %>
          <%= f.text_area :description, class: "form-control", rows: 3 %>
        </div>
      </div>

      <hr>

      <!-- Optimization Settings -->
      <div class="mb-4">
        <h5>Optimization Settings</h5>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <%= f.label :metric_to_optimize, "Metric to Optimize", class: "form-label" %>
            <%= f.select :metric_to_optimize, 
              options_for_select([
                ["Response Time", "response_time"],
                ["Cost", "cost"],
                ["Token Count", "token_count"],
                ["Success Rate", "success_rate"],
                ["Evaluation Score", "evaluation_score"]
              ], @ab_test.metric_to_optimize),
              {}, 
              class: "form-select" 
            %>
          </div>

          <div class="col-md-6 mb-3">
            <%= f.label :optimization_direction, "Direction", class: "form-label" %>
            <%= f.select :optimization_direction,
              options_for_select([
                ["Minimize (lower is better)", "minimize"],
                ["Maximize (higher is better)", "maximize"]
              ], @ab_test.optimization_direction),
              {},
              class: "form-select"
            %>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <%= f.label :confidence_level, "Confidence Level", class: "form-label" %>
            <%= f.select :confidence_level,
              options_for_select([
                ["90% (0.90)", 0.90],
                ["95% (0.95)", 0.95],
                ["99% (0.99)", 0.99]
              ], @ab_test.confidence_level),
              {},
              class: "form-select"
            %>
          </div>

          <div class="col-md-6 mb-3">
            <%= f.label :minimum_sample_size, "Minimum Sample Size", class: "form-label" %>
            <%= f.number_field :minimum_sample_size, class: "form-control", min: 10 %>
          </div>
        </div>
      </div>

      <hr>

      <!-- Variants -->
      <div class="mb-4">
        <h5>Variants</h5>

        <div id="variants-container">
          <% @ab_test.variants.each_with_index do |variant, index| %>
            <div class="row mb-3">
              <div class="col-md-3">
                <label class="form-label">Variant <%= variant["name"] %></label>
                <%= f.fields_for :variants, variant do |variant_fields| %>
                  <%= variant_fields.hidden_field :name, value: variant["name"] %>
                  <%= variant_fields.select :version_id,
                    options_from_collection_for_select(@available_versions, :id, :display_name, variant["version_id"]),
                    { prompt: "Select version..." },
                    class: "form-select"
                  %>
                <% end %>
              </div>
              <div class="col-md-3">
                <label class="form-label">Traffic %</label>
                <%= f.fields_for :traffic_split do |ts_fields| %>
                  <%= ts_fields.number_field variant["name"], value: @ab_test.traffic_split[variant["name"]], class: "form-control", min: 0, max: 100 %>
                <% end %>
              </div>
            </div>
          <% end %>

          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Traffic split must total 100%
          </div>
        </div>
      </div>

      <hr>

      <!-- Actions -->
      <div class="d-flex justify-content-between">
        <div>
          <%= link_to "Cancel", ab_test_path(@ab_test), class: "btn btn-outline-secondary" %>
          <%= button_to "Delete", ab_test_path(@ab_test), method: :delete, class: "btn btn-outline-danger", data: { confirm: "Are you sure? This cannot be undone." } %>
        </div>
        <%= f.submit "Update A/B Test", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

