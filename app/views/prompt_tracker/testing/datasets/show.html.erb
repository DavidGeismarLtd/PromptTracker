<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to @testable.name, testable_show_path(@testable) %></li>
  <li class="breadcrumb-item"><%= link_to "Datasets", datasets_index_path(@testable) %></li>
  <li class="breadcrumb-item active"><%= @dataset.name %></li>
<% end %>

<!-- Subscribe to Turbo Stream for real-time row updates -->
<%= turbo_stream_from "dataset_#{@dataset.id}_rows" %>

<!-- Flash Messages Container -->
<div id="flash-messages" class="mb-3"></div>

<div class="page-header" style="background-color: #EFF6FF; border-left: 4px solid #3B82F6; padding: 1.5rem; margin-bottom: 2rem;">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h1 style="color: #1E40AF; margin: 0;">
        <i class="bi bi-database"></i> <%= @dataset.name %>
        <%= testable_badge(@testable) %>
        <% if !@dataset.schema_valid? %>
          <span class="badge bg-danger" title="Schema no longer matches">
            <i class="bi bi-exclamation-triangle"></i> Invalid Schema
          </span>
        <% end %>
      </h1>
      <% if @dataset.description.present? %>
        <p style="color: #1E40AF; margin: 0.5rem 0 0 0;"><%= @dataset.description %></p>
      <% end %>
    </div>
    <div class="d-flex gap-2">
      <%= link_to datasets_index_path(@testable), class: "btn btn-outline-primary" do %>
        <i class="bi bi-arrow-left"></i> Back to Datasets
      <% end %>
      <%= link_to dataset_path(@dataset, action: :edit), class: "btn btn-outline-secondary" do %>
        <i class="bi bi-pencil"></i> Edit
      <% end %>
    </div>
  </div>
</div>

<!-- Schema Invalid Warning -->
<% if !@dataset.schema_valid? %>
  <div class="alert alert-danger mb-4">
    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Invalid Schema</h6>
    <p class="mb-0">
      This dataset's schema no longer matches the prompt version's variables schema.
      The dataset cannot be used for running tests until the schema is fixed.
    </p>
  </div>
<% end %>

<!-- Add Row Section -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add Rows</h5>
  </div>
  <div class="card-body">
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRowModal">
        <i class="bi bi-plus-circle"></i> Add Row Manually
      </button>
      <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#generateRowsModal">
        <i class="bi bi-stars"></i> Generate with AI
      </button>
    </div>

    <!-- Generation Status (updated via Turbo Streams) -->
    <div id="generation-status" class="mt-3">
      <!-- Status messages will appear here -->
    </div>
  </div>
</div>

<!-- Rows Table -->
<div class="card" data-controller="modal-fix">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-table"></i> Dataset Rows (<span id="dataset-row-count"><%= @dataset.row_count %></span>)</h5>
  </div>
  <div class="card-body" id="rows-table-container">
    <%= render "rows_table", rows: @rows, dataset: @dataset %>
  </div>
</div>

<!-- Modals with fix controller -->
<div data-controller="modal-fix">
  <%= render "add_row_modal" %>

  <!-- Generate Rows Modal -->
  <div class="modal fade" id="generateRowsModal" tabindex="-1" data-modal-fix-target="modal" data-controller="modal-fix">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <%= form_with(url: generate_rows_dataset_path(@dataset),
                      method: :post,
                      data: { turbo: false }) do |f| %>
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-stars"></i> Generate Rows with AI</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              <strong>AI-Powered Generation:</strong> The LLM will analyze your prompt templates and generate realistic test data that matches your schema.
            </div>

            <div class="mb-3">
              <%= f.label :count, "Number of Rows", class: "form-label" %>
              <%= f.number_field :count, value: 10, min: 1, max: 100, class: "form-control", required: true %>
              <div class="form-text">Generate between 1 and 100 rows (recommended: 10-20 for quick testing)</div>
            </div>

            <div class="mb-3">
              <%= f.label :instructions, "Custom Instructions (Optional)", class: "form-label" %>
              <%= f.text_area :instructions,
                              class: "form-control",
                              rows: 4,
                              placeholder: "e.g., 'Focus on edge cases with special characters' or 'Generate international examples with different languages'" %>
              <div class="form-text">Provide specific guidance to customize the generated data</div>
            </div>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i>
              <strong>Note:</strong> Generation happens in the background. Rows will appear in real-time as they're created.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <%= f.submit "Generate Rows", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
