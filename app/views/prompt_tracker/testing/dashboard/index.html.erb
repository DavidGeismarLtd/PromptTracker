<div class="tests-dashboard">
  <!-- Header with Create Button -->
  <div class="row mb-4">
    <div class="col">
      <h1>
        <i class="bi bi-check2-square"></i> Testing Dashboard
      </h1>
      <p class="text-muted">All agents in one place</p>
    </div>
    <div class="col-auto d-flex gap-2 align-items-start">
      <% if PromptTracker.configuration.feature_enabled?(:openai_assistant_sync) %>
        <%= link_to testing_sync_openai_assistants_root_path,
                    method: :post,
                    class: "btn btn-outline-primary",
                    data: { turbo_method: :post, turbo_confirm: "This will fetch all assistants from OpenAI and create agents for them. Continue?" } do %>
          <i class="bi bi-arrow-repeat"></i> Sync OpenAI Assistants
        <% end %>
      <% end %>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPromptModal">
        <i class="bi bi-plus-circle"></i> Create New Agent
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h6 class="text-muted">Total Tests</h6>
          <h3><%= @total_tests %></h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h6 class="text-muted">Runs Today</h6>
          <h3><%= @total_runs_today %></h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h6 class="text-muted">Pass Rate</h6>
          <h3><%= @pass_rate %>%</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <h6 class="text-muted">Agents</h6>
          <h3><%= @prompt_count %></h3>
          <small class="text-muted"><%= @prompt_count %> agents</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <% if @available_providers.any? || @available_models.any? %>
    <div class="card mb-4">
      <div class="card-body py-2">
        <%= form_with url: testing_root_path, method: :get, local: true, class: "row g-2 align-items-center" do %>
          <div class="col-auto">
            <label class="col-form-label"><i class="bi bi-funnel"></i> Filters:</label>
          </div>
          <div class="col-auto">
            <%= select_tag :provider,
                options_for_select([["All Providers", ""]] + @available_providers.map { |p| [p.titleize, p] }, @provider_filter),
                class: "form-select form-select-sm",
                onchange: "this.form.submit()" %>
          </div>
          <div class="col-auto">
            <%= select_tag :model,
                options_for_select([["All Models", ""]] + @available_models.map { |m| [m, m] }, @model_filter),
                class: "form-select form-select-sm",
                onchange: "this.form.submit()" %>
          </div>
          <% if @provider_filter.present? || @model_filter.present? %>
            <div class="col-auto">
              <%= link_to testing_root_path, class: "btn btn-sm btn-outline-secondary" do %>
                <i class="bi bi-x-circle"></i> Clear
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Agent List -->
  <% if @prompts.any? %>
    <div class="mb-4">
      <h4 class="mb-3">
        <i class="bi bi-chat-text"></i> Agents
        <span class="badge bg-secondary"><%= @prompts.count %></span>
      </h4>
      <%= render "prompt_tracker/shared/prompts_accordion", prompts: @prompts, show_monitor_button: false, search_enabled: false %>
    </div>
  <% else %>
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      <strong>No agents found.</strong>
      <% if @provider_filter.present? || @model_filter.present? %>
        No agents match the current filters. <%= link_to "Clear filters", testing_root_path %>.
      <% else %>
        Click "Create New Agent" to get started!
      <% end %>
    </div>
  <% end %>
</div>

<!-- Creation Wizard Modal -->
<%= render "create_prompt_modal" %>
