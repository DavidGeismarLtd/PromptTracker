<!-- Model Configuration Card -->
<div class="card mb-3">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="bi bi-gear"></i>
      Model Configuration
    </h5>
  </div>
  <div class="card-body">
    <%
      # Get available providers for playground context (only those with API keys)
      available_providers_list = providers_for(:playground)
      all_available_models = models_for(:playground)
      default_provider_value = default_provider_for(:playground)
      current_provider = @version&.model_config&.dig('provider') || default_provider_value&.to_s || available_providers_list.first.to_s

      # Build JSON data for JavaScript to use when switching providers
      models_by_provider = {}
      available_providers_list.each do |provider_key|
        provider_models = all_available_models[provider_key] || []
        models_by_provider[provider_key.to_s] = provider_models.map do |model|
          {
            id: model[:id],
            name: model[:name] || model[:id],
            category: model[:category]
          }
        end
      end
    %>
    <div class="mb-3">
      <label for="model-provider" class="form-label">Provider</label>
      <select
        id="model-provider"
        class="form-select"
        data-playground-target="modelProvider"
        data-action="change->playground#onProviderChange"
        data-models="<%= models_by_provider.to_json %>"
      >
        <% available_providers_list.each do |provider_key| %>
          <% provider_name = provider_key.to_s.titleize %>
          <option value="<%= provider_key %>" <%= 'selected' if current_provider == provider_key.to_s %>>
            <%= provider_name %>
          </option>
        <% end %>
      </select>
      <div class="form-text">LLM provider to use for API calls. Only providers with configured API keys are shown.</div>
    </div>

    <div class="mb-3">
      <label for="model-name" class="form-label">Model</label>
      <%
        provider = @version&.model_config&.dig('provider') || current_provider
        current_model = @version&.model_config&.dig('model')
        models = models_for(:playground, provider: provider.to_sym)
        # If no current model, use default or first available model from the provider
        current_model ||= default_model_for(:playground) || models.first&.dig(:id)
      %>
      <select
        id="model-name"
        class="form-select"
        data-playground-target="modelName"
        data-action="change->playground#onModelConfigChange"
      >
        <% if models.any? %>
          <% models.group_by { |m| m[:category] }.each do |category, models_in_category| %>
            <% if category.present? %>
              <optgroup label="<%= category %>">
            <% end %>

            <% models_in_category.each do |model| %>
              <option value="<%= model[:id] %>"
                      <%= 'selected' if current_model == model[:id] %>>
                <%= model[:name] || model[:id] %>
              </option>
            <% end %>

            <% if category.present? %>
              </optgroup>
            <% end %>
          <% end %>
        <% end %>
      </select>

      <div class="form-text">
        Select a model from the configured list
      </div>
    </div>

    <div class="mb-3">
      <label for="model-temperature" class="form-label">
        Temperature
        <span class="badge bg-secondary" data-playground-target="temperatureBadge">
          <%= @version&.model_config&.dig('temperature') || 0.7 %>
        </span>
      </label>
      <input
        type="range"
        id="model-temperature"
        class="form-range"
        min="0"
        max="2"
        step="0.1"
        value="<%= @version&.model_config&.dig('temperature') || 0.7 %>"
        data-playground-target="modelTemperature"
        data-action="input->playground#onModelConfigChange"
      >
      <div class="form-text">
        Controls randomness (0 = deterministic, 2 = very random)
      </div>
    </div>

    <div class="mb-3">
      <label for="model-max-tokens" class="form-label">Max Tokens (Optional)</label>
      <input
        type="number"
        id="model-max-tokens"
        class="form-control"
        placeholder="Leave empty for default"
        value="<%= @version&.model_config&.dig('max_tokens') %>"
        data-playground-target="modelMaxTokens"
        data-action="input->playground#onModelConfigChange"
      >
      <div class="form-text">
        Maximum tokens to generate (leave empty for provider default)
      </div>
    </div>

    <!-- Collapsible advanced options -->
    <div class="accordion" id="advancedModelConfig">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptions">
            <i class="bi bi-sliders me-2"></i>
            Advanced Options
          </button>
        </h2>
        <div id="advancedOptions" class="accordion-collapse collapse" data-bs-parent="#advancedModelConfig">
          <div class="accordion-body">
            <div class="mb-3">
              <label for="model-top-p" class="form-label">Top P (Optional)</label>
              <input
                type="number"
                id="model-top-p"
                class="form-control"
                placeholder="e.g., 0.9"
                step="0.1"
                min="0"
                max="1"
                value="<%= @version&.model_config&.dig('top_p') %>"
                data-playground-target="modelTopP"
                data-action="input->playground#onModelConfigChange"
              >
              <div class="form-text">Nucleus sampling parameter</div>
            </div>

            <div class="mb-3">
              <label for="model-frequency-penalty" class="form-label">Frequency Penalty (Optional)</label>
              <input
                type="number"
                id="model-frequency-penalty"
                class="form-control"
                placeholder="e.g., 0.5"
                step="0.1"
                min="-2"
                max="2"
                value="<%= @version&.model_config&.dig('frequency_penalty') %>"
                data-playground-target="modelFrequencyPenalty"
                data-action="input->playground#onModelConfigChange"
              >
              <div class="form-text">Penalize repeated tokens</div>
            </div>

            <div class="mb-3">
              <label for="model-presence-penalty" class="form-label">Presence Penalty (Optional)</label>
              <input
                type="number"
                id="model-presence-penalty"
                class="form-control"
                placeholder="e.g., 0.5"
                step="0.1"
                min="-2"
                max="2"
                value="<%= @version&.model_config&.dig('presence_penalty') %>"
                data-playground-target="modelPresencePenalty"
                data-action="input->playground#onModelConfigChange"
              >
              <div class="form-text">Penalize new topics</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
