<% content_for :breadcrumbs do %>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Monitoring", monitoring_root_path %></li>
      <li class="breadcrumb-item active" aria-current="page">Tracked Calls</li>
    </ol>
  </nav>
<% end %>

<div class="monitoring-responses-index">
  <!-- Header -->
  <div class="page-header" style="background-color: #ECFDF5; border-left: 4px solid #10B981; padding: 1.5rem; margin-bottom: 2rem;">
    <h1 style="color: #065F46; margin: 0;">
      <i class="bi bi-telephone"></i> Tracked LLM Calls
    </h1>
    <p style="color: #065F46; margin: 0.5rem 0 0 0;">
      All production LLM API calls
    </p>
  </div>

  <!-- Summary Stats -->
  <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="stat-card" style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Total Calls</div>
      <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;"><%= @total_responses %></div>
    </div>
    <div class="stat-card" style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Successful</div>
      <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;"><%= @successful_count %></div>
    </div>
    <div class="stat-card" style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Failed</div>
      <div style="color: #EF4444; font-size: 1.5rem; font-weight: bold;"><%= @failed_count %></div>
    </div>
  </div>

  <!-- Filters -->
  <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
    <%= form_with url: monitoring_llm_responses_path, method: :get, local: true, style: "margin: 0;" do |f| %>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
        <!-- Prompt Filter -->
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Prompt</label>
          <%= f.select :prompt_id,
              options_for_select([["All Prompts", ""]] + @prompts.map { |p| [p.name, p.id] }, params[:prompt_id]),
              {},
              style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
        </div>

        <!-- Provider Filter -->
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Provider</label>
          <%= f.select :provider,
              options_for_select([["All Providers", ""]] + @providers.map { |p| [p, p] }, params[:provider]),
              {},
              style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
        </div>

        <!-- Model Filter -->
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Model</label>
          <%= f.select :model,
              options_for_select([["All Models", ""]] + @models.map { |m| [m, m] }, params[:model]),
              {},
              style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
        </div>

        <!-- Status Filter -->
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Status</label>
          <%= f.select :status,
              options_for_select([["All Statuses", ""]] + @statuses.map { |s| [s.titleize, s] }, params[:status]),
              {},
              style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
        </div>

        <!-- Environment Filter -->
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Environment</label>
          <%= f.select :environment,
              options_for_select([["All Environments", ""]] + @environments.map { |e| [e, e] }, params[:environment]),
              {},
              style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
        </div>

        <!-- User ID Filter -->
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">User ID</label>
          <%= f.select :user_id,
              options_for_select([["All Users", ""]] + @user_ids.map { |u| [u, u] }, params[:user_id]),
              {},
              style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
        </div>

        <!-- Session ID Filter -->
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Session ID</label>
          <%= f.select :session_id,
              options_for_select([["All Sessions", ""]] + @session_ids.map { |s| [s, s] }, params[:session_id]),
              {},
              style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
        </div>

        <!-- Search -->
        <div>
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Search</label>
          <%= f.text_field :q, value: params[:q], placeholder: "Search prompts/responses...",
              style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 0.5rem;">
          <%= f.submit "Apply Filters", style: "background-color: #10B981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-weight: 500;" %>
          <%= link_to "Clear", monitoring_llm_responses_path, style: "background-color: #6B7280; color: white; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; text-decoration: none; display: inline-block; font-weight: 500;" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Responses Table -->
  <% if @responses.any? %>
    <div style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid #D1FAE5;">
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 120px;">Prompt</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 200px;">Rendered Prompt</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 200px;">Response</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 100px;">Environment</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 100px;">User ID</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 100px;">Session ID</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 150px;">Context</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 80px;">Status</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 100px;">Time</th>
            </tr>
          </thead>
          <tbody>
            <% @responses.each do |response| %>
              <tr style="border-bottom: 1px solid #F1F5F9;">
                <!-- Prompt Name -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <%= link_to llm_response_path(response), style: "color: #10B981; text-decoration: none; font-weight: 500;" do %>
                    <%= response.prompt_version.prompt.name %>
                    <br>
                    <small style="color: #94A3B8;">v<%= response.prompt_version.version_number %></small>
                  <% end %>
                </td>

                <!-- Rendered Prompt (truncated) -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <div style="max-width: 300px; font-size: 0.875rem; color: #475569; line-height: 1.4;">
                    <%= truncate_text(response.rendered_prompt, 150) %>
                  </div>
                </td>

                <!-- Response Text (truncated) -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <div style="max-width: 300px; font-size: 0.875rem; color: #475569; line-height: 1.4;">
                    <% if response.status == 'success' && response.response_text.present? %>
                      <%= truncate_text(response.response_text, 150) %>
                    <% elsif response.status == 'error' %>
                      <span style="color: #DC2626; font-style: italic;">
                        Error: <%= truncate_text(response.error_message || 'Unknown error', 100) %>
                      </span>
                    <% else %>
                      <span style="color: #94A3B8; font-style: italic;">No response</span>
                    <% end %>
                  </div>
                </td>

                <!-- Environment -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background-color: #F3F4F6; color: #374151; white-space: nowrap;">
                    <%= response.environment || '-' %>
                  </span>
                </td>

                <!-- User ID -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <% if response.user_id.present? %>
                    <code style="font-size: 0.75rem; color: #475569;"><%= response.user_id %></code>
                  <% else %>
                    <span style="color: #94A3B8; font-size: 0.75rem;">-</span>
                  <% end %>
                </td>

                <!-- Session ID -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <% if response.session_id.present? %>
                    <code style="font-size: 0.75rem; color: #475569;"><%= response.session_id %></code>
                  <% else %>
                    <span style="color: #94A3B8; font-size: 0.75rem;">-</span>
                  <% end %>
                </td>

                <!-- Context Metadata -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <% if response.context.present? && response.context.any? %>
                    <details style="cursor: pointer;">
                      <summary style="font-size: 0.75rem; color: #10B981; font-weight: 500;">View context</summary>
                      <pre style="font-size: 0.65rem; margin-top: 0.5rem; padding: 0.5rem; background: #F9FAFB; border-radius: 4px; max-width: 300px; overflow-x: auto;"><%= JSON.pretty_generate(response.context) %></pre>
                    </details>
                  <% else %>
                    <span style="color: #94A3B8; font-size: 0.75rem;">-</span>
                  <% end %>
                </td>

                <!-- Status -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background-color: <%= response.status == 'success' ? '#D1FAE5' : '#FEE2E2' %>; color: <%= response.status == 'success' ? '#065F46' : '#991B1B' %>; white-space: nowrap;">
                    <%= response.status %>
                  </span>
                </td>

                <!-- Time -->
                <td style="padding: 0.75rem; color: #64748B; font-size: 0.875rem; vertical-align: top; white-space: nowrap;">
                  <%= time_ago_in_words(response.created_at) %> ago
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div style="margin-top: 1.5rem; text-align: center;">
        <%= paginate @responses %>
      </div>
    </div>
  <% else %>
    <div style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 3rem; text-align: center;">
      <i class="bi bi-telephone" style="font-size: 3rem; color: #D1D5DB;"></i>
      <p style="color: #64748B; margin-top: 1rem;">No tracked calls found matching your filters.</p>
    </div>
  <% end %>
</div>
