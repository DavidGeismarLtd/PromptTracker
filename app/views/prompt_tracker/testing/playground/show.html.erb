<%
  # Compute URLs for conversation panel
  if @prompt_version
    execute_url = execute_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version)
    reset_url = reset_conversation_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version)
  elsif @prompt
    execute_url = execute_testing_prompt_playground_path(@prompt)
    reset_url = reset_conversation_testing_prompt_playground_path(@prompt)
  else
    execute_url = execute_testing_playground_path
    reset_url = reset_conversation_testing_playground_path
  end

  # Determine current provider/API
  current_provider = @version&.model_config&.dig('provider') || default_provider_for(:playground)&.to_s
  current_api = @version&.model_config&.dig('api') || default_api_for(:playground)&.to_s

  # Get UI panels to show for current API
  playground_ui = PromptTracker::ApiCapabilities.playground_ui_for(
    current_provider&.to_sym,
    current_api&.to_sym
  )

  # Determine if current API requires remote entity sync
  is_remote_entity_linked = PromptTracker::ApiCapabilities.supports_feature?(
    current_provider&.to_sym,
    current_api&.to_sym,
    :remote_entity_linked
  )

  # Get sync status from model_config
  sync_status = @version&.model_config&.dig('metadata', 'sync_status') ||
                @version&.model_config&.dig(:metadata, :sync_status)
  synced_at = @version&.model_config&.dig('metadata', 'synced_at') ||
              @version&.model_config&.dig(:metadata, :synced_at)

  # Serialize capabilities matrix for JavaScript
  capabilities_json = PromptTracker::ApiCapabilities.to_h.to_json
%>

<div id="playground-container"
     class="container-fluid mt-4"
     data-controller="playground-editor playground-preview playground-save playground-sync playground-response-schema playground-ui"
     data-playground-editor-generate-prompt-outlet="#generate-prompt-controller"
     data-playground-ui-conversation-outlet="#conversation-panel"
     data-playground-ui-capabilities-value="<%= capabilities_json %>"
     data-action="playground-editor:promptChanged->playground-preview#onPromptChanged"
     <% if @prompt_version %>
       data-playground-preview-preview-url-value="<%= preview_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
       data-playground-save-save-url-value="<%= save_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
       data-playground-save-prompt-id-value="<%= @prompt.id %>"
       data-playground-save-version-id-value="<%= @prompt_version.id %>"
       data-playground-sync-version-id-value="<%= @prompt_version.id %>"
     <% elsif @prompt %>
       data-playground-preview-preview-url-value="<%= preview_testing_prompt_playground_path(@prompt) %>"
       data-playground-save-save-url-value="<%= save_testing_prompt_playground_path(@prompt) %>"
       data-playground-save-prompt-id-value="<%= @prompt.id %>"
       <% if @version %>
         data-playground-save-version-id-value="<%= @version.id %>"
         data-playground-sync-version-id-value="<%= @version.id %>"
       <% end %>
     <% else %>
       data-playground-preview-preview-url-value="<%= preview_testing_playground_path %>"
       data-playground-save-save-url-value="<%= save_testing_playground_path %>"
     <% end %>
>
  <div class="row mb-3">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "Testing", testing_root_path %></li>
          <li class="breadcrumb-item active" aria-current="page">Playground</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col">
      <h1>
        <i class="bi bi-play-circle"></i>
        <% if @prompt %>
          Playground: <%= @prompt.name %>
          <% if @version %>
            <span class="badge bg-primary">v<%= @version.version_number %></span>
          <% end %>
        <% else %>
          Prompt Playground
        <% end %>
      </h1>
      <p class="text-muted">
        <% if @prompt_version %>
          Testing specific version <%= @version.version_number %> of <%= @prompt.name %>.
        <% elsif @prompt %>
          Editing <%= @prompt.name %> (using <%= @version ? "v#{@version.version_number}" : "no version" %>).
        <% else %>
          Draft and test your prompt template with live preview.
        <% end %>
        Supports Liquid template syntax with <code>{{ variable }}</code> and <code>{{ variable | filter }}</code>.
      </p>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#keyboardShortcutsModal">
        <i class="bi bi-keyboard"></i> Keyboard Shortcuts
      </button>
      <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#templateExamplesModal">
        <i class="bi bi-lightbulb"></i> Examples
      </button>
    </div>
  </div>

  <!-- Alert for messages -->
  <div id="playground-alert"
       class="alert alert-dismissible fade"
       role="alert"
       style="display: none;"
       data-playground-save-target="alertContainer">
    <span id="playground-alert-message"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- AI Prompt Generation Info -->
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="bi bi-stars"></i>
    <strong>AI-Powered Prompt Generation:</strong>
    When the prompt fields are empty, click the <strong>Generate</strong> button to describe what you want and the AI will create a complete prompt with variables.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- Split pane layout -->
  <div class="row">
    <!-- Left pane: Prompt editors -->
    <%= render "prompt_tracker/testing/playground/prompt_editors",
               playground_ui: playground_ui,
               version: @version %>

    <!-- Right pane: Model config, Variables, and Preview -->
    <div class="col-lg-6 mb-4">

      <!-- Model Configuration Panel -->
      <%= render "prompt_tracker/testing/playground/model_config_panel" %>

      <!-- Variables and Preview Section -->
      <div data-playground-ui-target="variablesPreviewSection"
           style="<%= (playground_ui.include?(:variables) || playground_ui.include?(:preview)) ? '' : 'display: none;' %>">

        <!-- Variable Definition Panel -->
        <%= render "prompt_tracker/testing/playground/variable_definition_panel",
                   sample_variables: @sample_variables %>

        <!-- Preview Panel -->
        <%= render "prompt_tracker/testing/playground/preview_panel" %>
      </div>
    </div>

    <!-- Conversation Panel (shown for all APIs that support it) -->
    <div class="col-lg-12 mb-4"
         data-playground-ui-target="conversationSection"
         style="<%= playground_ui.include?(:conversation) ? '' : 'display: none;' %>">
      <%= render "prompt_tracker/testing/playground/conversation_panel",
                 conversation_state: respond_to?(:conversation_state_from_session) ? conversation_state_from_session(session) : {},
                 execute_url: execute_url,
                 reset_url: reset_url %>
    </div>
  </div>

  <!-- Action buttons -->
  <div class="row mt-3">
    <div class="col">
      <% unless @prompt %>
        <!-- Prompt name and slug inputs for standalone mode -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="prompt-name-input" class="form-label">Prompt Name</label>
            <input
              type="text"
              class="form-control"
              id="prompt-name-input"
              placeholder="e.g., Customer Support Greeting"
              required
              data-playground-save-target="promptName"
              data-action="input->playground-save#onPromptNameInput"
            >
            <div class="form-text">Human-friendly name for display</div>
          </div>
          <div class="col-md-6">
            <label for="prompt-slug-input" class="form-label">
              Slug
              <span class="badge bg-secondary">Auto-generated</span>
            </label>
            <input
              type="text"
              class="form-control font-monospace"
              id="prompt-slug-input"
              placeholder="customer_support_greeting"
              data-playground-save-target="promptSlug"
            >
            <div class="form-text">Used in code (lowercase, numbers, underscores only)</div>
          </div>
        </div>
      <% end %>

      <% if @prompt %>
        <% if @version && !@version.has_responses? %>
          <!-- Dropdown button for versions without responses -->
          <div class="btn-group" role="group">
            <button id="save-update-btn"
                    type="button"
                    class="btn btn-primary"
                    data-playground-save-target="saveUpdateBtn"
                    data-action="click->playground-save#saveUpdate">
              <i class="bi bi-save"></i> Update This Version
            </button>
            <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
              <li>
                <button id="save-new-version-btn"
                        class="dropdown-item"
                        type="button"
                        data-playground-save-target="saveNewVersionBtn"
                        data-action="click->playground-save#saveNewVersion">
                  <i class="bi bi-plus-circle"></i> Save as New Version
                </button>
              </li>
            </ul>
          </div>
        <% else %>
          <!-- Single button for versions with responses or no version -->
          <button id="save-draft-btn"
                  class="btn btn-primary"
                  data-playground-save-target="saveDraftBtn"
                  data-action="click->playground-save#saveDraft">
            <i class="bi bi-save"></i> Save as Draft Version
          </button>
        <% end %>
      <% else %>
        <!-- Standalone mode -->
        <button id="save-draft-btn"
                class="btn btn-primary"
                data-playground-save-target="saveDraftBtn"
                data-action="click->playground-save#saveDraft">
          <i class="bi bi-save"></i> Create Prompt
        </button>
        <a href="<%= testing_root_path %>" class="btn btn-outline-secondary">
          <i class="bi bi-x-circle"></i>
          Cancel
        </a>
      <% end %>

      <!-- Sync Now button (only for remote entity linked APIs) -->
      <% if is_remote_entity_linked && @version %>
        <button id="sync-now-btn"
                type="button"
                class="btn btn-outline-primary ms-2"
                data-playground-sync-target="syncNowBtn"
                data-action="click->playground-sync#syncRemoteEntity"
                title="Sync with remote assistant">
          <i class="bi bi-cloud-arrow-up"></i> Sync Now
          <% if sync_status == 'synced' && synced_at %>
            <span class="badge bg-success ms-1" title="Last synced: <%= synced_at %>">✓</span>
          <% elsif sync_status == 'failed' %>
            <span class="badge bg-danger ms-1">✗</span>
          <% elsif sync_status == 'pending' %>
            <span class="badge bg-warning ms-1">⚠</span>
          <% end %>
        </button>
      <% end %>
    </div>
  </div>

  <!-- Modals (inside playground controller scope) -->
  <div data-controller="modal-fix generate-prompt"
       id="generate-prompt-controller"
       data-generate-prompt-playground-outlet="[data-controller~='playground-editor']"
       <% if @prompt_version %>
         data-generate-prompt-generate-url-value="<%= generate_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
       <% elsif @prompt %>
         data-generate-prompt-generate-url-value="<%= generate_testing_prompt_playground_path(@prompt) %>"
       <% else %>
         data-generate-prompt-generate-url-value="<%= generate_testing_playground_path %>"
       <% end %>
  >
    <%= render "prompt_tracker/testing/playground/keyboard_shortcuts_modal" %>
    <%= render "prompt_tracker/testing/playground/template_examples_modal" %>
    <%= render "prompt_tracker/testing/playground/generate_prompt_modal" %>
    <%= render "prompt_tracker/testing/playground/generating_modal" %>
  </div>
</div>
<!-- End of playground controller -->
