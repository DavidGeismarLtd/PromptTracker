<!-- Run Test Modal -->
<div class="modal fade" id="runTestModal-<%= test.id %>" tabindex="-1"
     data-controller="modal-fix run-test-modal"
     data-modal-fix-target="modal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Run Test: <%= test.name %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <%= form_with(url: run_testing_prompt_prompt_version_prompt_test_path(prompt, version, test), method: :post, data: { turbo: false, "run-test-modal-target": "form" }) do |f| %>
        <div class="modal-body">
          <p class="text-muted mb-3">
            Choose how to run this test:
          </p>

          <!-- Run Mode Selection -->
          <div class="mb-4">
            <div class="form-check mb-3">
              <%= f.radio_button :run_mode, "dataset",
                  id: "run_mode_dataset_#{test.id}",
                  checked: true,
                  class: "form-check-input",
                  data: {
                    action: "change->run-test-modal#toggleMode",
                    "run-test-modal-target": "modeRadio"
                  } %>
              <%= f.label :run_mode_dataset, "Run against dataset", for: "run_mode_dataset_#{test.id}", class: "form-check-label" do %>
                <strong>Run against dataset</strong>
                <small class="d-block text-muted">Execute test for all rows in a dataset</small>
              <% end %>
            </div>

            <div class="form-check">
              <%= f.radio_button :run_mode, "single",
                  id: "run_mode_single_#{test.id}",
                  class: "form-check-input",
                  data: {
                    action: "change->run-test-modal#toggleMode",
                    "run-test-modal-target": "modeRadio"
                  } %>
              <%= f.label :run_mode_single, "Single run with custom variables", for: "run_mode_single_#{test.id}", class: "form-check-label" do %>
                <strong>Single run with custom variables</strong>
                <small class="d-block text-muted">Execute test once with manually entered values</small>
              <% end %>
            </div>
          </div>

          <!-- Dataset Selection (shown when run_mode=dataset) -->
          <div data-run-test-modal-target="datasetSection">
            <% if version.datasets.any? %>
              <div class="mb-3">
                <%= f.label :dataset_id, "Select Dataset", class: "form-label" %>
                <span class="text-danger">*</span>
                <%= f.select :dataset_id,
                    options_from_collection_for_select(version.datasets, :id, :name),
                    { prompt: "Choose a dataset..." },
                    class: "form-select",
                    data: { "run-test-modal-target": "datasetSelect", required: "true" } %>
                <small class="form-text text-muted">
                  The test will run once for each row in the selected dataset.
                </small>
              </div>
            <% else %>
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                No datasets available for this prompt version.
                <%= link_to "Create a dataset", testing_prompt_prompt_version_datasets_path(prompt, version), class: "alert-link" %>
                to run tests against multiple data rows.
              </div>
            <% end %>
          </div>

          <!-- Custom Variables (shown when run_mode=single) -->
          <div data-run-test-modal-target="customSection" style="display: none;">
            <% if version.variables_schema.present? %>
              <p class="text-muted mb-3">
                Enter values for the prompt variables:
              </p>

              <% version.variables_schema.each do |var_config| %>
                <% var_name = var_config["name"] %>
                <% is_required = var_config["required"] %>
                <div class="mb-3">
                  <%= label_tag "custom_variables[#{var_name}]", var_name.to_s.humanize, class: "form-label" %>
                  <% if is_required %>
                    <span class="text-danger">*</span>
                  <% end %>

                  <% if var_config["type"] == "text" %>
                    <%= text_area_tag "custom_variables[#{var_name}]",
                        nil,
                        class: "form-control",
                        rows: 3,
                        data: { required: is_required.to_s },
                        placeholder: var_config["description"] %>
                  <% else %>
                    <%= text_field_tag "custom_variables[#{var_name}]",
                        nil,
                        class: "form-control",
                        data: { required: is_required.to_s },
                        placeholder: var_config["description"] %>
                  <% end %>

                  <% if var_config["description"].present? %>
                    <small class="form-text text-muted"><%= var_config["description"] %></small>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                This prompt version has no variables defined.
              </div>
            <% end %>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit "Run Test", class: "btn btn-success", data: { "run-test-modal-target": "submitButton" } %>
        </div>
      <% end %>
    </div>
  </div>
</div>
