<div class="card mb-4">
  <div class="card-header bg-light">
    <h5 class="mb-0" style="color: #374151;">
      <i class="bi bi-globe"></i>
      Web Search Evaluation
    </h5>
  </div>
  <div class="card-body">
    <% metadata = evaluation.metadata || {} %>
    <% config = metadata['config'] || {} %>
    <% web_search_count = metadata['web_search_count'] || 0 %>
    <% queries = metadata['queries'] || [] %>
    <% sources = metadata['sources'] || [] %>
    <% expected_queries = metadata['expected_queries'] || [] %>
    <% expected_domains = metadata['expected_domains'] || [] %>
    <% matched_queries = metadata['matched_queries'] || [] %>
    <% matched_domains = metadata['matched_domains'] || [] %>
    <% require_web_search = config['require_web_search'] %>
    <% min_sources = config['min_sources'] || 0 %>
    <% threshold_score = config['threshold_score'] || 80 %>

    <!-- Overall Score and Status -->
    <div class="row mb-3">
      <div class="col-md-4">
        <div class="alert <%= evaluation.passed? ? 'alert-success' : 'alert-danger' %> mb-0">
          <strong>Score:</strong> <%= number_with_precision(evaluation.score, precision: 1) %>/100
        </div>
      </div>
      <div class="col-md-4">
        <div class="alert alert-secondary mb-0">
          <strong>Threshold:</strong> <%= threshold_score %>/100
        </div>
      </div>
      <div class="col-md-4">
        <div class="alert <%= web_search_count > 0 ? 'alert-info' : 'alert-warning' %> mb-0">
          <strong>Searches:</strong> <%= web_search_count %>
        </div>
      </div>
    </div>

    <!-- Web Search Usage Summary -->
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-search"></i> Queries Made</h6>
            <% if queries.any? %>
              <ul class="list-group list-group-flush">
                <% queries.each do |query| %>
                  <li class="list-group-item px-0 py-2">
                    <code><%= query %></code>
                  </li>
                <% end %>
              </ul>
            <% else %>
              <p class="text-muted mb-0"><em>No queries detected</em></p>
            <% end %>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-link-45deg"></i> Sources Found</h6>
            <p class="mb-2"><strong>Total Sources:</strong> <%= sources.count %></p>
            <% if min_sources > 0 %>
              <p class="mb-0">
                <strong>Minimum Required:</strong> <%= min_sources %>
                <% if sources.count >= min_sources %>
                  <span class="badge bg-success ms-1"><i class="bi bi-check"></i> Met</span>
                <% else %>
                  <span class="badge bg-danger ms-1"><i class="bi bi-x"></i> Not Met</span>
                <% end %>
              </p>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Expected Queries Check -->
    <% if expected_queries.any? %>
      <div class="mb-3">
        <h6><i class="bi bi-list-check"></i> Expected Queries</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>Expected Query</th>
                <th class="text-center" style="width: 120px;">Status</th>
              </tr>
            </thead>
            <tbody>
              <% expected_queries.each do |expected_query| %>
                <% is_matched = matched_queries.include?(expected_query) %>
                <tr>
                  <td><code><%= expected_query %></code></td>
                  <td class="text-center">
                    <% if is_matched %>
                      <span class="badge bg-success"><i class="bi bi-check-circle"></i> Matched</span>
                    <% else %>
                      <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Not Found</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <% if config['require_all_queries'] %>
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> <strong>All queries required</strong> - All expected queries must be matched
          </div>
        <% else %>
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> <strong>Any query accepted</strong> - At least one expected query must be matched
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Expected Domains Check -->
    <% if expected_domains.any? %>
      <div class="mb-3">
        <h6><i class="bi bi-globe2"></i> Expected Domains</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>Expected Domain</th>
                <th class="text-center" style="width: 120px;">Status</th>
              </tr>
            </thead>
            <tbody>
              <% expected_domains.each do |expected_domain| %>
                <% is_matched = matched_domains.include?(expected_domain) %>
                <tr>
                  <td><code><%= expected_domain %></code></td>
                  <td class="text-center">
                    <% if is_matched %>
                      <span class="badge bg-success"><i class="bi bi-check-circle"></i> Found</span>
                    <% else %>
                      <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Not Found</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <% if config['require_all_domains'] %>
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> <strong>All domains required</strong> - All expected domains must be found in sources
          </div>
        <% else %>
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i> <strong>Any domain accepted</strong> - At least one expected domain must be found
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Source Details -->
    <% if sources.any? %>
      <div class="mb-3">
        <h6><i class="bi bi-file-earmark-text"></i> Source Details</h6>
        <div class="accordion" id="sourcesAccordion">
          <% sources.first(10).each_with_index do |source, index| %>
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading<%= index %>">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                  <i class="bi bi-link-45deg me-2"></i>
                  <small><%= truncate(source['title'] || source['url'] || "Source #{index + 1}", length: 80) %></small>
                </button>
              </h2>
              <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#sourcesAccordion">
                <div class="accordion-body">
                  <% if source['url'].present? %>
                    <p class="mb-2">
                      <strong>URL:</strong>
                      <a href="<%= source['url'] %>" target="_blank" rel="noopener noreferrer" class="text-break">
                        <%= source['url'] %>
                        <i class="bi bi-box-arrow-up-right ms-1"></i>
                      </a>
                    </p>
                  <% end %>
                  <% if source['title'].present? %>
                    <p class="mb-2"><strong>Title:</strong> <%= source['title'] %></p>
                  <% end %>
                  <% if source['snippet'].present? %>
                    <p class="mb-0">
                      <strong>Snippet:</strong><br>
                      <small class="text-muted"><%= source['snippet'] %></small>
                    </p>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
        <% if sources.count > 10 %>
          <div class="alert alert-info mt-2 mb-0">
            <i class="bi bi-info-circle"></i> Showing first 10 of <%= sources.count %> sources
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Overall Feedback -->
    <% if evaluation.feedback.present? %>
      <div class="alert <%= evaluation.passed? ? 'alert-success' : 'alert-warning' %> mb-0">
        <strong>Summary:</strong><br>
        <%= simple_format(evaluation.feedback) %>
      </div>
    <% end %>
  </div>
</div>
