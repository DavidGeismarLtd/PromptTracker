<%#
  Response API Tools Configuration
  Shown when Response API is selected

  Local variables:
    - available_tools: Array of tool hashes from Configuration#tools_for_api
    - enabled_tools: Hash with tool configs (e.g., {"web_search" => true, "file_search" => {"vector_store_ids" => [...]}})
    - tool_config: Hash with detailed tool configuration (file_search vector_store_ids, functions array)
%>

<%
  available_tools ||= []
  # Handle both array format (legacy) and hash format (new)
  if enabled_tools.is_a?(Array)
    enabled_tools_hash = enabled_tools.each_with_object({}) { |t, h| h[t.to_s] = true }
  else
    enabled_tools_hash = enabled_tools || {}
  end
  tool_config ||= @version&.model_config&.dig('tool_config') || {}
%>

<style>
  .tool-card {
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    border: 2px solid transparent;
  }
  .tool-card:hover {
    border-color: var(--bs-primary);
    background-color: var(--bs-light);
  }
  .tool-card.active {
    border-color: var(--bs-primary);
    background-color: rgba(var(--bs-primary-rgb), 0.1);
  }
  .tool-card .tool-icon {
    font-size: 1.25rem;
    opacity: 0.6;
    transition: opacity 0.15s ease-in-out;
  }
  .tool-card.active .tool-icon {
    opacity: 1;
    color: var(--bs-primary);
  }
  .tool-card .check-indicator {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    color: var(--bs-primary);
    transition: opacity 0.15s ease-in-out;
  }
  .tool-card.active .check-indicator {
    opacity: 1;
  }
  .tool-config-panel {
    display: none;
    animation: slideDown 0.2s ease-out;
  }
  .tool-config-panel.show {
    display: block;
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="response-api-tools mt-3"
     data-controller="tools-config"
     data-playground-target="responseApiTools">
  <label class="form-label">
    <i class="bi bi-tools"></i> Response API Tools
    <span class="badge bg-info ms-1">Beta</span>
  </label>
  <div class="form-text mb-2">
    Enable built-in tools for the Response API. These tools allow the model to search the web,
    analyze files, execute code, and call custom functions.
  </div>

  <div class="row g-2" data-playground-target="responseApiToolsContent">
    <% available_tools.each do |tool| %>
      <%
        is_enabled = enabled_tools_hash[tool[:id].to_s].present?
        card_class = is_enabled ? 'active' : ''
        is_configurable = tool[:configurable] == true
      %>
      <div class="col-md-3">
        <label class="card tool-card p-3 h-100 position-relative <%= card_class %>"
               for="tool_<%= tool[:id] %>"
               data-action="click->playground#onToolCardClick">
          <input class="d-none"
                 type="checkbox"
                 id="tool_<%= tool[:id] %>"
                 value="<%= tool[:id] %>"
                 data-playground-target="toolCheckbox"
                 data-tools-config-target="toolCheckbox"
                 data-tool-id="<%= tool[:id] %>"
                 data-configurable="<%= is_configurable %>"
                 data-action="change->playground#onToolChange change->tools-config#onToolToggle"
                 <%= 'checked' if is_enabled %>>
          <i class="bi bi-check-circle-fill check-indicator"></i>
          <div class="text-center">
            <i class="bi <%= tool[:icon] %> tool-icon d-block mb-2"></i>
            <strong class="d-block" style="font-size: 0.85rem;"><%= tool[:name] %></strong>
            <small class="text-muted" style="font-size: 0.7rem;"><%= tool[:description] %></small>
          </div>
        </label>
      </div>
    <% end %>
  </div>

  <%# File Search Configuration Panel %>
  <% file_search_config = tool_config.dig('file_search') || {} %>
  <div id="file-search-config"
       class="tool-config-panel mt-3 p-3 border rounded bg-light <%= 'show' if enabled_tools_hash['file_search'].present? %>"
       data-tools-config-target="fileSearchPanel">
    <h6 class="mb-3">
      <i class="bi bi-file-earmark-search me-1"></i>
      File Search Configuration
    </h6>
    <div class="mb-3">
      <label class="form-label">Vector Stores</label>
      <div class="d-flex gap-2 mb-2">
        <select class="form-select form-select-sm"
                id="vector-store-select"
                data-tools-config-target="vectorStoreSelect">
          <option value="">Select a vector store...</option>
        </select>
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="click->tools-config#loadVectorStores"
                title="Refresh list">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button type="button"
                class="btn btn-sm btn-primary"
                data-action="click->tools-config#addVectorStore"
                title="Add selected store">
          <i class="bi bi-plus"></i> Add
        </button>
        <button type="button"
                class="btn btn-sm btn-success"
                data-action="click->tools-config#showCreateVectorStoreModal"
                title="Create new vector store">
          <i class="bi bi-cloud-upload"></i> New
        </button>
      </div>
      <div id="selected-vector-stores"
           class="d-flex flex-wrap gap-2 mb-2"
           data-tools-config-target="selectedVectorStores">
        <% (file_search_config['vector_store_ids'] || []).each do |vs_id| %>
          <span class="badge bg-primary d-flex align-items-center gap-1" data-vector-store-id="<%= vs_id %>">
            <%= vs_id.truncate(20) %>
            <button type="button" class="btn-close btn-close-white" style="font-size: 0.6rem;"
                    data-action="click->tools-config#removeVectorStore"></button>
          </span>
        <% end %>
      </div>
      <div class="form-text">
        Select existing vector stores or create a new one with uploaded files.
      </div>
    </div>
  </div>

  <%# Create Vector Store Modal - will be moved to body by JS for z-index fix %>
  <div class="modal fade" id="createVectorStoreModal" tabindex="-1" data-tools-config-target="createVectorStoreModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-cloud-upload me-2"></i>Create Vector Store
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Name <span class="text-danger">*</span></label>
            <input type="text"
                   class="form-control"
                   placeholder="e.g., Product Documentation"
                   data-tools-config-target="vectorStoreName">
            <div class="form-text">A descriptive name for your vector store.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Files <span class="text-danger">*</span></label>
            <input type="file"
                   class="form-control"
                   multiple
                   accept=".txt,.md,.pdf,.docx,.doc,.html,.json,.csv"
                   data-tools-config-target="vectorStoreFiles">
            <div class="form-text">
              Upload files to include in the vector store. Supported: TXT, MD, PDF, DOCX, HTML, JSON, CSV.
            </div>
          </div>
          <div class="alert alert-info py-2 d-none" data-tools-config-target="createVectorStoreStatus">
            <i class="bi bi-hourglass-split me-1"></i>
            <span data-tools-config-target="createVectorStoreStatusText">Creating...</span>
          </div>
          <div class="alert alert-danger py-2 d-none" data-tools-config-target="createVectorStoreError">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <span data-tools-config-target="createVectorStoreErrorText"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button"
                  class="btn btn-primary"
                  data-action="click->tools-config#createVectorStore"
                  data-tools-config-target="createVectorStoreButton">
            <i class="bi bi-cloud-upload me-1"></i>Create & Upload
          </button>
        </div>
      </div>
    </div>
  </div>

  <%# Functions Configuration Panel %>
  <% functions_config = tool_config.dig('functions') || [] %>
  <div id="functions-config"
       class="tool-config-panel mt-3 p-3 border rounded bg-light <%= 'show' if enabled_tools_hash['functions'].present? %>"
       data-tools-config-target="functionsPanel">
    <h6 class="mb-3 d-flex justify-content-between align-items-center">
      <span>
        <i class="bi bi-braces-asterisk me-1"></i>
        Custom Functions
      </span>
      <button type="button"
              class="btn btn-sm btn-primary"
              data-action="click->tools-config#addFunction">
        <i class="bi bi-plus"></i> Add Function
      </button>
    </h6>

    <div id="functions-list" data-tools-config-target="functionsList">
      <% if functions_config.empty? %>
        <div class="text-muted text-center py-3" data-tools-config-target="noFunctionsMessage">
          <i class="bi bi-info-circle"></i>
          No functions defined. Click "Add Function" to create one.
        </div>
      <% else %>
        <% functions_config.each_with_index do |func, idx| %>
          <%= render 'prompt_tracker/testing/playground/function_item', function: func, index: idx %>
        <% end %>
      <% end %>
    </div>
  </div>

  <% if available_tools.empty? %>
    <div class="alert alert-secondary py-2" data-playground-target="noToolsAlert">
      <i class="bi bi-info-circle"></i>
      No tools available for this API.
    </div>
  <% end %>
</div>
