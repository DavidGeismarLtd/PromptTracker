<td class="conversation-cell">
  <% if run.conversation_data.present? %>
    <% messages = run.conversation_data["messages"] || [] %>
    <% if messages.any? %>
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#conversation-<%= run.id %>" aria-expanded="false">
        <i class="bi bi-chat-dots"></i> View Conversation (<%= messages.length %> messages)
      </button>
      <div class="collapse mt-2" id="conversation-<%= run.id %>">
        <div class="card card-body">
          <% messages.each_with_index do |message, index| %>
            <div class="mb-3 <%= message['role'] == 'user' ? 'text-end' : '' %>">
              <div class="d-inline-block text-start" style="max-width: 80%;">
                <div class="mb-1">
                  <% if message['role'] == 'user' %>
                    <span class="badge bg-primary">User</span>
                  <% else %>
                    <span class="badge bg-success">Assistant</span>
                  <% end %>
                  <small class="text-muted">Turn <%= (index / 2.0).ceil %></small>
                </div>
                <div class="p-2 rounded <%= message['role'] == 'user' ? 'bg-primary text-white' : 'bg-light' %>">
                  <%= simple_format(message['content']) %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <span class="text-muted">No messages</span>
    <% end %>
  <% else %>
    <span class="text-muted">No conversation data</span>
  <% end %>
</td>

