<%
  # Compute URLs for conversation panel
  if @prompt_version
    conversation_url = run_conversation_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version)
    reset_url = reset_conversation_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version)
  elsif @prompt
    conversation_url = run_conversation_testing_prompt_playground_path(@prompt)
    reset_url = reset_conversation_testing_prompt_playground_path(@prompt)
  else
    conversation_url = run_conversation_testing_playground_path
    reset_url = reset_conversation_testing_playground_path
  end

  # Determine current provider/API
  current_provider = @version&.model_config&.dig('provider') || default_provider_for(:playground)&.to_s
  current_api = @version&.model_config&.dig('api') || default_api_for(:playground)&.to_s

  # Get UI panels to show for current API
  playground_ui = PromptTracker::ApiCapabilities.playground_ui_for(
    current_provider&.to_sym,
    current_api&.to_sym
  )

  # Determine if current API requires remote entity sync
  is_remote_entity_linked = PromptTracker::ApiCapabilities.supports_feature?(
    current_provider&.to_sym,
    current_api&.to_sym,
    :remote_entity_linked
  )

  # Get sync status from model_config
  sync_status = @version&.model_config&.dig('metadata', 'sync_status') ||
                @version&.model_config&.dig(:metadata, :sync_status)
  synced_at = @version&.model_config&.dig('metadata', 'synced_at') ||
              @version&.model_config&.dig(:metadata, :synced_at)

  # Serialize capabilities matrix for JavaScript
  capabilities_json = PromptTracker::ApiCapabilities.to_h.to_json

  # Determine which controllers to load based on capabilities
  # playground-preview is only needed when :preview is in playground_ui
  controllers = ["playground-save", "playground-sync", "playground-response-schema", "playground-ui", "playground-generate-prompt"]
  controllers.unshift("playground-preview") if playground_ui.include?(:preview)
%>

<div id="playground-container"
     class="container-fluid mt-4"
     data-controller="<%= controllers.join(' ') %>"
     data-playground-ui-playground-conversation-outlet="#conversation-panel"
     data-playground-ui-playground-tools-outlet="#tools-panel"
     data-playground-ui-capabilities-value="<%= capabilities_json %>"
     <% if playground_ui.include?(:preview) %>
       data-playground-preview-playground-prompt-editor-outlet="#prompt-editor-panel"
       data-playground-preview-playground-variables-outlet="#variables-panel"
     <% end %>
     data-playground-save-playground-prompt-editor-outlet="#prompt-editor-panel"
     data-playground-save-playground-variables-outlet="#variables-panel"
     data-playground-save-playground-model-config-outlet="#model-config-panel"
     data-playground-save-playground-tools-outlet="#tools-panel"
     data-playground-save-playground-file-search-outlet="#file-search-config"
     data-playground-save-playground-functions-outlet="#functions-config"
     data-action="<%= playground_ui.include?(:preview) ? 'playground-prompt-editor:promptChanged->playground-preview#onPromptChanged ' : '' %>playground-prompt-editor:promptChanged->playground-generate-prompt#onPromptChanged<%= playground_ui.include?(:preview) ? ' playground-variables:changed->playground-preview#onVariablesChanged' : '' %>"
     data-playground-sync-playground-prompt-editor-outlet="#prompt-editor-panel"
     data-playground-sync-playground-model-config-outlet="#model-config-panel"
     <% if @prompt_version %>
       <% if playground_ui.include?(:preview) %>
         data-playground-preview-preview-url-value="<%= preview_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
       <% end %>
       data-playground-save-save-url-value="<%= save_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
       data-playground-save-check-version-impact-url-value="<%= check_version_impact_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
       data-playground-save-prompt-id-value="<%= @prompt.id %>"
       data-playground-save-prompt-name-value="<%= @prompt.name %>"
       data-playground-save-version-id-value="<%= @prompt_version.id %>"
       data-playground-save-current-version-number-value="<%= @prompt_version.version_number %>"
       data-playground-sync-push-url-value="<%= push_to_remote_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
       data-playground-sync-pull-url-value="<%= pull_from_remote_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
       <% assistant_id = @prompt_version.model_config&.dig(:assistant_id) %>
       <% if assistant_id.present? %>
         data-playground-sync-remote-entity-id-value="<%= assistant_id %>"
       <% end %>
       data-playground-generate-prompt-generate-url-value="<%= generate_testing_prompt_prompt_version_playground_path(@prompt, @prompt_version) %>"
     <% elsif @prompt %>
       <% if playground_ui.include?(:preview) %>
         data-playground-preview-preview-url-value="<%= preview_testing_prompt_playground_path(@prompt) %>"
       <% end %>
       data-playground-save-save-url-value="<%= save_testing_prompt_playground_path(@prompt) %>"
       data-playground-save-check-version-impact-url-value="<%= check_version_impact_testing_prompt_playground_path(@prompt) %>"
       data-playground-save-prompt-id-value="<%= @prompt.id %>"
       data-playground-save-prompt-name-value="<%= @prompt.name %>"
       data-playground-sync-push-url-value="<%= push_to_remote_testing_prompt_playground_path(@prompt) %>"
       data-playground-sync-pull-url-value="<%= pull_from_remote_testing_prompt_playground_path(@prompt) %>"
       data-playground-generate-prompt-generate-url-value="<%= generate_testing_prompt_playground_path(@prompt) %>"
       <% if @version %>
         data-playground-save-version-id-value="<%= @version.id %>"
         data-playground-save-current-version-number-value="<%= @version.version_number %>"
         <% assistant_id = @version.model_config&.dig(:assistant_id) %>
         <% if assistant_id.present? %>
           data-playground-sync-remote-entity-id-value="<%= assistant_id %>"
         <% end %>
       <% end %>
     <% else %>
       <% if playground_ui.include?(:preview) %>
         data-playground-preview-preview-url-value="<%= preview_testing_playground_path %>"
       <% end %>
       data-playground-save-save-url-value="<%= save_testing_playground_path %>"
       data-playground-save-check-version-impact-url-value="<%= check_version_impact_testing_playground_path %>"
       data-playground-sync-push-url-value="<%= push_to_remote_testing_playground_path %>"
       data-playground-sync-pull-url-value="<%= pull_from_remote_testing_playground_path %>"
       data-playground-generate-prompt-generate-url-value="<%= generate_testing_playground_path %>"
     <% end %>
>
  <div class="row mb-3">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "Testing", testing_root_path %></li>
          <li class="breadcrumb-item active" aria-current="page">Playground</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col">
      <h1>
        <i class="bi bi-play-circle"></i>
        <% if @prompt %>
          Playground: <%= @prompt.name %>
          <% if @version %>
            <span class="badge bg-primary">v<%= @version.version_number %></span>
            <span class="badge <%= version_state_badge_class(@version) %>"><%= version_state_label(@version) %></span>
          <% end %>
        <% else %>
          Prompt Playground
          <span class="badge bg-success">Development</span>
        <% end %>
      </h1>
      <p class="text-muted">
        <% if @prompt_version %>
          Testing specific version <%= @version.version_number %> of <%= @prompt.name %>.
          <span class="small"><i class="bi bi-info-circle"></i> <%= version_state_description(@version) %></span>
        <% elsif @prompt %>
          Editing <%= @prompt.name %> (using <%= @version ? "v#{@version.version_number}" : "no version" %>).
          <% if @version %>
            <span class="small"><i class="bi bi-info-circle"></i> <%= version_state_description(@version) %></span>
          <% end %>
        <% else %>
          Draft and test your prompt template with live preview.
          <span class="small"><i class="bi bi-info-circle"></i> All changes are allowed.</span>
        <% end %>
        Supports Liquid template syntax with <code>{{ variable }}</code> and <code>{{ variable | filter }}</code>.
      </p>
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#keyboardShortcutsModal">
        <i class="bi bi-keyboard"></i> Keyboard Shortcuts
      </button>
      <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#templateExamplesModal">
        <i class="bi bi-lightbulb"></i> Examples
      </button>
    </div>
  </div>

  <!-- Alert for messages -->
  <div id="playground-alert"
       class="alert alert-dismissible fade"
       role="alert"
       style="display: none;"
       data-playground-save-target="alertContainer">
    <span id="playground-alert-message"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- AI Prompt Generation Info -->
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="bi bi-stars"></i>
    <strong>AI-Powered Prompt Generation:</strong>
    When the prompt fields are empty, click the <strong>Generate</strong> button to describe what you want and the AI will create a complete prompt with variables.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- Split pane layout -->
  <div class="row">
    <!-- Left pane: Prompt editors -->
    <%= render "prompt_tracker/testing/playground/prompt_editors",
               playground_ui: playground_ui,
               version: @version %>

    <!-- Right pane: Model config, Variables, and Preview -->
    <div class="col-lg-6 mb-4">

      <!-- Model Configuration Panel -->
      <%= render "prompt_tracker/testing/playground/model_config_panel" %>

      <!-- Variables and Preview Section -->
      <div data-playground-ui-target="variablesPreviewSection"
           style="<%= show_variables_preview?(playground_ui) ? '' : 'display: none;' %>">

        <!-- Variable Definition Panel -->
        <%= render "prompt_tracker/testing/playground/variable_definition_panel",
                   sample_variables: @sample_variables %>

        <!-- Preview Panel -->
        <%= render "prompt_tracker/testing/playground/preview_panel" %>
      </div>
    </div>

    <!-- Conversation Panel (shown for all APIs that support it) -->
    <div class="col-lg-12 mb-4"
         data-playground-ui-target="conversationSection"
         style="<%= playground_ui.include?(:conversation) ? '' : 'display: none;' %>">
      <%= render "prompt_tracker/testing/playground/conversation_panel",
                 conversation_state: respond_to?(:conversation_state_from_session) ? conversation_state_from_session(session) : {},
                 conversation_url: conversation_url,
                 reset_url: reset_url %>
    </div>
  </div>

  <!-- Action buttons -->
  <%= render "prompt_tracker/testing/playground/action_buttons",
             prompt: @prompt,
             version: @version,
             is_remote_entity_linked: is_remote_entity_linked,
             sync_status: sync_status,
             synced_at: synced_at %>

  <!-- Modals (inside playground controller scope) -->
  <div data-controller="modal-fix">
    <%= render "prompt_tracker/testing/playground/keyboard_shortcuts_modal" %>
    <%= render "prompt_tracker/testing/playground/template_examples_modal" %>
    <%= render "prompt_tracker/testing/playground/generate_prompt_modal" %>
    <%= render "prompt_tracker/testing/playground/generating_modal" %>
    <%= render "prompt_tracker/testing/playground/save_modal" %>
  </div>
</div>
<!-- End of playground controller -->
