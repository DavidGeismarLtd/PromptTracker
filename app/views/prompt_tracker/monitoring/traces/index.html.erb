<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "Monitoring", monitoring_root_path %></li>
  <li class="breadcrumb-item active">Traces</li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-diagram-2"></i> Traces
      <span class="badge bg-secondary"><%= @traces.total_count %></span>
    </h1>
    <p class="text-muted">Browse all execution traces</p>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: monitoring_traces_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-2">
        <%= f.label :status, "Status", class: "form-label" %>
        <%= f.select :status, options_for_select(@statuses, params[:status]), 
            { include_blank: "All Statuses" }, 
            class: "form-select" %>
      </div>

      <div class="col-md-2">
        <%= f.label :user_id, "User", class: "form-label" %>
        <%= f.select :user_id, options_for_select(@users, params[:user_id]), 
            { include_blank: "All Users" }, 
            class: "form-select" %>
      </div>

      <div class="col-md-3">
        <%= f.label :session_id, "Session", class: "form-label" %>
        <%= f.select :session_id, options_for_select(@sessions.first(20), params[:session_id]), 
            { include_blank: "All Sessions" }, 
            class: "form-select" %>
      </div>

      <div class="col-md-2">
        <%= f.label :q, "Search Name", class: "form-label" %>
        <%= f.text_field :q, value: params[:q], class: "form-control", placeholder: "Search..." %>
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <%= f.submit "Filter", class: "btn btn-primary me-2" %>
        <%= link_to "Clear", monitoring_traces_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Traces Table -->
<div class="card">
  <div class="card-body">
    <% if @traces.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Name</th>
              <th>Session</th>
              <th>User</th>
              <th>Status</th>
              <th class="text-center">Spans</th>
              <th class="text-center">LLM Calls</th>
              <th class="text-end">Duration</th>
              <th>Started</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @traces.each do |trace| %>
              <tr>
                <td><strong><%= trace.name %></strong></td>
                <td>
                  <% if trace.session_id.present? %>
                    <%= link_to truncate(trace.session_id, length: 20), monitoring_session_path(trace.session_id), class: "text-decoration-none" %>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if trace.user_id.present? %>
                    <span class="badge bg-secondary"><%= trace.user_id %></span>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if trace.status == 'completed' %>
                    <span class="badge bg-success">✓ Completed</span>
                  <% elsif trace.status == 'error' %>
                    <span class="badge bg-danger">✗ Error</span>
                  <% elsif trace.status == 'running' %>
                    <span class="badge bg-warning">⟳ Running</span>
                  <% else %>
                    <span class="badge bg-secondary"><%= trace.status %></span>
                  <% end %>
                </td>
                <td class="text-center">
                  <span class="badge bg-info"><%= trace.spans.count %></span>
                </td>
                <td class="text-center">
                  <span class="badge bg-primary"><%= trace.llm_responses.count %></span>
                </td>
                <td class="text-end"><%= format_duration(trace.duration_ms) %></td>
                <td>
                  <%= format_relative_time(trace.started_at) %>
                  <br>
                  <small class="text-muted"><%= format_timestamp(trace.started_at) %></small>
                </td>
                <td>
                  <%= link_to "View", monitoring_trace_path(trace), class: "btn btn-sm btn-outline-primary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-3">
        <%= paginate @traces %>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No traces found</p>
        <% if params.values.any?(&:present?) %>
          <%= link_to "Clear filters", monitoring_traces_path, class: "btn btn-outline-primary" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

