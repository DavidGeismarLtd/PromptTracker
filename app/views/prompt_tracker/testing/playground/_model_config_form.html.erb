<!-- Model Configuration Card -->
<div class="card mb-3">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="bi bi-gear"></i>
      Model Configuration
    </h5>
  </div>
  <div class="card-body">
    <%
      # Get available providers for playground context (only those with API keys)
      available_providers_list = providers_for(:playground)
      default_provider_value = default_provider_for(:playground)
      default_api_value = default_api_for(:playground)
      current_provider = @version&.model_config&.dig('provider') || default_provider_value&.to_s || available_providers_list.first.to_s
      current_api = @version&.model_config&.dig('api') || default_api_value&.to_s || default_api_for_provider(current_provider.to_sym)&.to_s

      # Build JSON data for JavaScript cascading selects
      # Structure: { provider: { apis: [...], models_by_api: { api: [...models] }, tools_by_api: { api: [...tools] } } }
      provider_data = {}
      available_providers_list.each do |provider_key|
        apis = apis_for(provider_key)
        models_by_api = {}
        tools_by_api = {}
        apis.each do |api|
          api_models = models_for_api(provider_key, api[:key])
          models_by_api[api[:key].to_s] = api_models.map do |model|
            {
              id: model[:id],
              name: model[:name] || model[:id],
              category: model[:category]
            }
          end
          # Get tools for this provider/API from configuration
          tools_by_api[api[:key].to_s] = PromptTracker.configuration.tools_for_api(provider_key, api[:key])
        end
        provider_data[provider_key.to_s] = {
          name: provider_name(provider_key),
          apis: apis.map { |a| { key: a[:key].to_s, name: a[:name], default: a[:default], description: a[:description], capabilities: a[:capabilities] } },
          models_by_api: models_by_api,
          tools_by_api: tools_by_api
        }
      end

      # Get current models for initial render
      current_model = @version&.model_config&.dig('model')
      models = models_for_api(current_provider.to_sym, current_api.to_sym)
      current_model ||= default_model_for(:playground) || models.first&.dig(:id)

      # Check if current API has special capabilities (for showing tools)
      current_api_config = apis_for(current_provider.to_sym).find { |a| a[:key].to_s == current_api.to_s }
      has_response_api_tools = current_api_config&.dig(:capabilities)&.include?(:web_search)
    %>
    <div class="mb-3">
      <label for="model-provider" class="form-label">Provider</label>
      <select
        id="model-provider"
        class="form-select"
        data-playground-target="modelProvider"
        data-action="change->playground#onProviderChange"
        data-provider-data="<%= provider_data.to_json %>"
      >
        <% available_providers_list.each do |provider_key| %>
          <option value="<%= provider_key %>" <%= 'selected' if current_provider == provider_key.to_s %>>
            <%= provider_name(provider_key) %>
          </option>
        <% end %>
      </select>
      <div class="form-text">LLM provider to use for API calls. Only providers with configured API keys are shown.</div>
    </div>

    <%# API Selection - shown when provider has multiple APIs %>
    <% provider_apis = apis_for(current_provider.to_sym) %>
    <div class="mb-3" id="api-select-container"
         data-playground-target="apiSelectContainer"
         style="<%= provider_apis.size <= 1 ? 'display: none;' : '' %>">
      <label for="model-api" class="form-label">API</label>
      <select
        id="model-api"
        class="form-select"
        data-playground-target="modelApi"
        data-action="change->playground#onApiChange"
      >
        <% provider_apis.each do |api| %>
          <option value="<%= api[:key] %>"
                  <%= 'selected' if current_api == api[:key].to_s %>
                  data-description="<%= api[:description] %>"
                  data-capabilities="<%= api[:capabilities].to_json %>">
            <%= api[:name] %>
          </option>
        <% end %>
      </select>
      <div class="form-text" data-playground-target="apiDescription">
        <%= current_api_config&.dig(:description) || "Select an API endpoint" %>
      </div>
    </div>

    <%# Response API Tools - shown when API has tool capabilities %>
    <%
      # Get tools for current provider/API from configuration
      current_available_tools = PromptTracker.configuration.tools_for_api(
        current_provider.to_sym,
        current_api.to_sym
      )
    %>
    <div id="response-api-tools-container"
         style="<%= has_response_api_tools ? '' : 'display: none;' %>"
         data-playground-target="responseApiToolsContainer">
      <%= render "prompt_tracker/testing/playground/response_api_tools",
                 available_tools: current_available_tools,
                 enabled_tools: @version&.model_config&.dig('tools') || [] %>
    </div>

    <div class="mb-3">
      <label for="model-name" class="form-label">Model</label>
      <select
        id="model-name"
        class="form-select"
        data-playground-target="modelName"
        data-action="change->playground#onModelConfigChange"
      >
        <% if models.any? %>
          <% models.group_by { |m| m[:category] }.each do |category, models_in_category| %>
            <% if category.present? %>
              <optgroup label="<%= category %>">
            <% end %>

            <% models_in_category.each do |model| %>
              <option value="<%= model[:id] %>"
                      <%= 'selected' if current_model == model[:id] %>>
                <%= model[:name] || model[:id] %>
              </option>
            <% end %>

            <% if category.present? %>
              </optgroup>
            <% end %>
          <% end %>
        <% end %>
      </select>

      <div class="form-text">
        Select a model from the configured list
      </div>
    </div>

    <div class="mb-3">
      <label for="model-temperature" class="form-label">
        Temperature
        <span class="badge bg-secondary" data-playground-target="temperatureBadge">
          <%= @version&.model_config&.dig('temperature') || 0.7 %>
        </span>
      </label>
      <input
        type="range"
        id="model-temperature"
        class="form-range"
        min="0"
        max="2"
        step="0.1"
        value="<%= @version&.model_config&.dig('temperature') || 0.7 %>"
        data-playground-target="modelTemperature"
        data-action="input->playground#onModelConfigChange"
      >
      <div class="form-text">
        Controls randomness (0 = deterministic, 2 = very random)
      </div>
    </div>

    <div class="mb-3">
      <label for="model-max-tokens" class="form-label">Max Tokens (Optional)</label>
      <input
        type="number"
        id="model-max-tokens"
        class="form-control"
        placeholder="Leave empty for default"
        value="<%= @version&.model_config&.dig('max_tokens') %>"
        data-playground-target="modelMaxTokens"
        data-action="input->playground#onModelConfigChange"
      >
      <div class="form-text">
        Maximum tokens to generate (leave empty for provider default)
      </div>
    </div>

    <!-- Collapsible advanced options -->
    <div class="accordion" id="advancedModelConfig">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptions">
            <i class="bi bi-sliders me-2"></i>
            Advanced Options
          </button>
        </h2>
        <div id="advancedOptions" class="accordion-collapse collapse" data-bs-parent="#advancedModelConfig">
          <div class="accordion-body">
            <div class="mb-3">
              <label for="model-top-p" class="form-label">Top P (Optional)</label>
              <input
                type="number"
                id="model-top-p"
                class="form-control"
                placeholder="e.g., 0.9"
                step="0.1"
                min="0"
                max="1"
                value="<%= @version&.model_config&.dig('top_p') %>"
                data-playground-target="modelTopP"
                data-action="input->playground#onModelConfigChange"
              >
              <div class="form-text">Nucleus sampling parameter</div>
            </div>

            <div class="mb-3">
              <label for="model-frequency-penalty" class="form-label">Frequency Penalty (Optional)</label>
              <input
                type="number"
                id="model-frequency-penalty"
                class="form-control"
                placeholder="e.g., 0.5"
                step="0.1"
                min="-2"
                max="2"
                value="<%= @version&.model_config&.dig('frequency_penalty') %>"
                data-playground-target="modelFrequencyPenalty"
                data-action="input->playground#onModelConfigChange"
              >
              <div class="form-text">Penalize repeated tokens</div>
            </div>

            <div class="mb-3">
              <label for="model-presence-penalty" class="form-label">Presence Penalty (Optional)</label>
              <input
                type="number"
                id="model-presence-penalty"
                class="form-control"
                placeholder="e.g., 0.5"
                step="0.1"
                min="-2"
                max="2"
                value="<%= @version&.model_config&.dig('presence_penalty') %>"
                data-playground-target="modelPresencePenalty"
                data-action="input->playground#onModelConfigChange"
              >
              <div class="form-text">Penalize new topics</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Structured Output / Response Schema -->
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#responseSchemaOptions">
            <i class="bi bi-braces me-2"></i>
            Structured Output (JSON Schema)
            <% if @version&.response_schema.present? %>
              <span class="badge bg-success ms-2">Configured</span>
            <% end %>
          </button>
        </h2>
        <div id="responseSchemaOptions" class="accordion-collapse collapse" data-bs-parent="#advancedModelConfig">
          <div class="accordion-body">
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle me-1"></i>
              <strong>Structured Outputs</strong> guarantee the LLM response matches your JSON Schema.
              Supported by OpenAI gpt-4o models and Anthropic Claude 3.
              <a href="https://platform.openai.com/docs/guides/structured-outputs" target="_blank" class="alert-link">
                Learn more <i class="bi bi-box-arrow-up-right"></i>
              </a>
            </div>

            <div class="mb-3">
              <label for="response-schema" class="form-label">
                Response Schema (JSON Schema)
              </label>
              <textarea
                id="response-schema"
                class="form-control font-monospace"
                rows="10"
                placeholder='{
  "type": "object",
  "properties": {
    "sentiment": {
      "type": "string",
      "enum": ["positive", "negative", "neutral"]
    },
    "confidence": {
      "type": "number"
    }
  },
  "required": ["sentiment", "confidence"]
}'
                data-playground-target="responseSchema"
              ><%= @version&.response_schema.present? ? JSON.pretty_generate(@version.response_schema) : '' %></textarea>
              <div class="form-text">
                Define the structure of the LLM response. Leave empty for free-form text responses.
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" data-action="click->playground#validateResponseSchema">
                <i class="bi bi-check-circle me-1"></i>
                Validate JSON
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-action="click->playground#clearResponseSchema">
                <i class="bi bi-x-circle me-1"></i>
                Clear
              </button>
            </div>

            <div id="response-schema-error" class="alert alert-danger mt-2 d-none" data-playground-target="responseSchemaError">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
