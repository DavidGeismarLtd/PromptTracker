<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item active">Sessions</li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-diagram-3"></i> Sessions
      <span class="badge bg-secondary"><%= @sessions.total_count %></span>
    </h1>
    <p class="text-muted">Browse all conversation and workflow sessions</p>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: sessions_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-3">
        <%= f.label :user_id, "User", class: "form-label" %>
        <%= f.select :user_id, options_for_select(@users, params[:user_id]), 
            { include_blank: "All Users" }, 
            class: "form-select" %>
      </div>

      <div class="col-md-3">
        <%= f.label :start_date, "Start Date", class: "form-label" %>
        <%= f.date_field :start_date, value: params[:start_date], class: "form-control" %>
      </div>

      <div class="col-md-3">
        <%= f.label :end_date, "End Date", class: "form-label" %>
        <%= f.date_field :end_date, value: params[:end_date], class: "form-control" %>
      </div>

      <div class="col-md-3 d-flex align-items-end">
        <%= f.submit "Filter", class: "btn btn-primary me-2" %>
        <%= link_to "Clear", sessions_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Sessions Table -->
<div class="card">
  <div class="card-body">
    <% if @sessions.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Session ID</th>
              <th class="text-center">Traces</th>
              <th class="text-center">Status</th>
              <th>First Activity</th>
              <th>Last Activity</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @sessions.each do |session| %>
              <tr>
                <td>
                  <code><%= session.session_id %></code>
                </td>
                <td class="text-center">
                  <span class="badge bg-primary"><%= session.trace_count %></span>
                </td>
                <td class="text-center">
                  <% if session.error_count.to_i > 0 %>
                    <span class="badge bg-danger" title="<%= session.error_count %> errors">
                      <%= session.completed_count %>/<%= session.trace_count %>
                    </span>
                  <% else %>
                    <span class="badge bg-success">
                      <%= session.completed_count %>/<%= session.trace_count %>
                    </span>
                  <% end %>
                </td>
                <td><%= format_timestamp(session.first_activity) %></td>
                <td>
                  <%= format_relative_time(session.last_activity) %>
                  <br>
                  <small class="text-muted"><%= format_timestamp(session.last_activity) %></small>
                </td>
                <td>
                  <%= link_to "View Details", session_path(session.session_id), class: "btn btn-sm btn-outline-primary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-3">
        <%= paginate @sessions %>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No sessions found</p>
        <% if params[:user_id].present? || params[:start_date].present? || params[:end_date].present? %>
          <%= link_to "Clear filters", sessions_path, class: "btn btn-outline-primary" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

