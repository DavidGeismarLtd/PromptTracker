<!-- Modals with Stimulus controller for z-index fix -->
<div data-controller="modal-fix">
  <!-- Add Evaluator Modal -->
  <div class="modal fade" id="addEvaluatorModal" tabindex="-1" aria-labelledby="addEvaluatorModalLabel" aria-hidden="true" data-modal-fix-target="modal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addEvaluatorModalLabel">Add Auto-Evaluator</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with model: [@prompt, @version, PromptTracker::EvaluatorConfig.new],
                    url: prompt_evaluator_configs_path(@prompt),
                    local: true,
                    data: { controller: "evaluator-config-form", evaluator_config_form_prompt_id_value: @prompt.id, evaluator_config_form_version_id_value: @version.id } do |f| %>
        <%= f.hidden_field :configurable_type, value: "PromptTracker::PromptVersion" %>
        <%= f.hidden_field :configurable_id, value: @version.id %>

        <div class="modal-body">
          <!-- Evaluator Selection -->
          <div class="mb-3">
            <%= f.label :evaluator_key, "Evaluator", class: "form-label" %>
            <%= f.select :evaluator_key,
                         options_for_select(PromptTracker::EvaluatorRegistry.all.map { |k, v| [v[:name], k] }),
                         { include_blank: "Select an evaluator..." },
                         {
                           class: "form-select",
                           required: true,
                           data: {
                             evaluator_config_form_target: "select",
                             action: "change->evaluator-config-form#loadForm",
                             evaluators: PromptTracker::EvaluatorRegistry.all.to_json
                           }
                         } %>
            <div data-evaluator-config-form-target="description" class="form-text mt-2"></div>
          </div>

          <!-- Enabled -->
          <div class="mb-3 form-check">
            <%= f.check_box :enabled, class: "form-check-input", checked: true %>
            <%= f.label :enabled, "Enabled (run this evaluator automatically on tracked calls)", class: "form-check-label" %>
          </div>

          <!-- Dynamic Configuration Form (Turbo Frame) -->
          <turbo-frame id="evaluator_config_container">
            <div class="text-center py-4 text-muted">
              <i class="bi bi-arrow-up"></i>
              <p>Select an evaluator above to configure it</p>
            </div>
          </turbo-frame>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit "Add Auto-Evaluator", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
    </div>
  </div>

  <!-- Edit Evaluator Modal -->
  <div class="modal fade" id="editEvaluatorModal" tabindex="-1" aria-labelledby="editEvaluatorModalLabel" aria-hidden="true" data-modal-fix-target="modal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editEvaluatorModalLabel">Edit Auto-Evaluator</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editEvaluatorForm">
        <input type="hidden" id="edit_evaluator_id" name="id">
        <div class="modal-body">
          <!-- Evaluator Key (Read-only) -->
          <div class="mb-3">
            <label for="edit_evaluator_key" class="form-label">Evaluator</label>
            <input type="text" id="edit_evaluator_key" class="form-control" readonly>
          </div>

          <!-- Enabled -->
          <div class="mb-3 form-check">
            <input type="checkbox" id="edit_enabled" class="form-check-input">
            <label for="edit_enabled" class="form-check-label">Enabled (run this evaluator automatically on tracked calls)</label>
          </div>

          <!-- Config (JSON) -->
          <div class="mb-3">
            <label for="edit_config" class="form-label">Configuration (JSON)</label>
            <textarea id="edit_config" rows="8" class="form-control font-monospace"></textarea>
            <div class="form-text">Evaluator-specific configuration as JSON.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  </div>
</div>

<script>
// Edit evaluator form submission
document.addEventListener('DOMContentLoaded', function() {
  const editForm = document.getElementById('editEvaluatorForm');
  if (editForm) {
    editForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const configId = document.getElementById('edit_evaluator_id').value;
      const formData = {
        evaluator_config: {
          enabled: document.getElementById('edit_enabled').checked,
          config: JSON.parse(document.getElementById('edit_config').value)
        }
      };

      fetch(`/prompt_tracker/prompts/<%= @prompt.id %>/evaluators/${configId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify(formData)
      })
      .then(response => {
        if (response.ok) {
          window.location.reload();
        } else {
          alert('Failed to update evaluator configuration');
        }
      })
      .catch(error => {
        console.error('Error updating evaluator config:', error);
        alert('Failed to update evaluator configuration');
      });
    });
  }
});

// Edit evaluator config
function editEvaluatorConfig(configId) {
  fetch(`/prompt_tracker/prompts/<%= @prompt.id %>/evaluators/${configId}.json`)
    .then(response => response.json())
    .then(config => {
      document.getElementById('edit_evaluator_id').value = configId;
      document.getElementById('edit_evaluator_key').value = config.evaluator_key;
      document.getElementById('edit_enabled').checked = config.enabled;
      document.getElementById('edit_config').value = JSON.stringify(config.config, null, 2);

      const modal = new bootstrap.Modal(document.getElementById('editEvaluatorModal'));
      modal.show();
    })
    .catch(error => {
      console.error('Error fetching evaluator config:', error);
      alert('Failed to load evaluator configuration');
    });
}
</script>
