<%= turbo_stream_from @version.testable_stream_name %>

<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item active"><%= @prompt.name %>-v<%= @version.version_number %></li>
<% end %>

<div class="testing-prompt-version-show">
  <!-- Header -->
  <div class="page-header" style="background-color: #EFF6FF; border-left: 4px solid #3B82F6; padding: 1.5rem; margin-bottom: 2rem;">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h1 style="color: #1E40AF; margin: 0;">
          <i class="bi bi-flask"></i> <%= @prompt.name %>
          <span class="badge bg-primary">v<%= @version.version_number %></span>
          <%= status_badge(@version.status) %>
        </h1>
        <div style="margin-top: 0.5rem;">
          <code style="background-color: #DBEAFE; color: #1E40AF; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">
            prompt_slug: "<%= @prompt.slug %>"
          </code>
        </div>
        <% if @version.notes.present? %>
          <p style="color: #1E40AF; margin: 0.5rem 0 0 0;">
            <%= @version.notes %>
          </p>
        <% end %>
      </div>
      <div class="d-flex gap-2 align-items-start">
        <%= link_to testing_prompt_prompt_version_datasets_path(@prompt, @version), class: "btn btn-outline-primary" do %>
          <i class="bi bi-database"></i> Datasets
        <% end %>
        <%= link_to monitoring_prompt_prompt_version_path(@prompt, @version), class: "btn btn-outline-success" do %>
          <i class="bi bi-activity"></i> View in Monitoring
        <% end %>
        <% unless @version.active? %>
          <%= button_to activate_testing_prompt_prompt_version_path(@prompt, @version), method: :post, class: "btn btn-success", data: { confirm: "Activate this version? This will deprecate all other versions." } do %>
            <i class="bi bi-check-circle"></i> Activate Version
          <% end %>
        <% end %>
        <%= link_to testing_prompt_prompt_version_playground_path(@prompt, @version), class: "btn btn-primary" do %>
          <i class="bi bi-pencil-square"></i> Edit in Playground
        <% end %>
        <%= link_to compare_testing_prompt_prompt_version_path(@prompt, @version), class: "btn btn-outline-info" do %>
          <i class="bi bi-arrow-left-right"></i> Compare Versions
        <% end %>
      </div>
    </div>
  </div>

  <!-- Statistics -->
  <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="stat-card" style="background: white; border: 2px solid #DBEAFE; border-radius: 8px; padding: 1rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Total Tests</div>
      <div style="color: #3B82F6; font-size: 1.5rem; font-weight: bold;"><%= @total_tests %></div>
    </div>
    <div class="stat-card" style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Passing</div>
      <div style="color: #10B981; font-size: 1.5rem; font-weight: bold;"><%= @tests_passing %></div>
      <div style="color: #64748B; font-size: 0.75rem; margin-top: 0.25rem;">
        <% if @total_tests > 0 %>
          <%= ((@tests_passing.to_f / @total_tests) * 100).round(1) %>% pass rate
        <% end %>
      </div>
    </div>
    <div class="stat-card" style="background: white; border: 2px solid #FEE2E2; border-radius: 8px; padding: 1rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Failing</div>
      <div style="color: #EF4444; font-size: 1.5rem; font-weight: bold;"><%= @tests_failing %></div>
    </div>
    <div class="stat-card" style="background: white; border: 2px solid #DBEAFE; border-radius: 8px; padding: 1rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Test Cost</div>
      <div style="color: #3B82F6; font-size: 1.5rem; font-weight: bold;"><%= format_cost(@total_cost) %></div>
      <div style="color: #64748B; font-size: 0.75rem; margin-top: 0.25rem;">From test runs</div>
    </div>
    <div class="stat-card" style="background: white; border: 2px solid #DBEAFE; border-radius: 8px; padding: 1rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Avg Response Time</div>
      <div style="color: #3B82F6; font-size: 1.5rem; font-weight: bold;"><%= format_duration(@avg_response_time) %></div>
      <div style="color: #64748B; font-size: 0.75rem; margin-top: 0.25rem;">Test runs average</div>
    </div>
  </div>
</div>

<!-- Prompts & Model Config -->
<div class="row mb-4">
  <div class="col-md-<%= @version.model_config.present? && @version.model_config.any? ? '8' : '12' %>">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-file-text"></i> Prompts</h6>
        <span class="badge bg-secondary"><%= (@version.system_prompt.to_s.length + @version.user_prompt.length) %> chars</span>
      </div>
      <div class="card-body">
        <% if @version.system_prompt.present? %>
          <div class="mb-3">
            <div class="badge bg-secondary mb-2">System Prompt</div>
            <pre class="mb-0 border-start border-3 border-secondary ps-3" style="max-height: 150px; overflow-y: auto;"><code><%= @version.system_prompt %></code></pre>
          </div>
        <% end %>
        <div>
          <div class="badge bg-primary mb-2">User Prompt</div>
          <pre class="mb-0 border-start border-3 border-primary ps-3" style="max-height: 150px; overflow-y: auto;"><code><%= @version.user_prompt %></code></pre>
        </div>
      </div>
    </div>
  </div>
  <% if @version.model_config.present? && @version.model_config.any? %>
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-gear"></i> Model Config</h6>
        </div>
        <div class="card-body">
          <% @version.model_config.each do |key, value| %>
            <div class="mb-2">
              <small class="text-muted d-block"><%= key.to_s.titleize %></small>
              <strong><%= value %></strong>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<%= render "prompt_tracker/testing/tests/tests_card", tests: @tests, testable_param: @version %>

<%= render "prompt_tracker/testing/tests/new_test_modal",
           badge_html: content_tag(:span, "v#{@version.version_number}", class: "badge bg-primary"),
           form_partial_path: "prompt_tracker/testing/tests/prompt_versions/form",
           form_locals: { prompt: @prompt, version: @version, test: PromptTracker::Test.new(testable: @version, enabled: true), in_modal: true } %>

<%= render "prompt_tracker/testing/tests/run_test_modal",
    testable: @version,
    tests: @tests,
    form_url: run_all_testing_prompt_version_tests_path(@version),
    modal_id: "runAllTestsModal",
    modal_title: "Run All Tests",
    submit_button_text: "Run All Tests",
    datasets_path: testing_prompt_prompt_version_datasets_path(@prompt, @version),
    intro_text: "Choose how to run all #{@tests.count} test(s):",
    dataset_mode_description: "Execute each test for all rows in a dataset",
    custom_mode_description: "Execute each test once with manually entered values",
    custom_variables_context: "Enter values for the prompt variables (will be used for all tests):" %>
