<%# Assistant Playground - Split-screen interface for creating/editing assistants %>

<div class="container-fluid mt-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>
        <i class="bi bi-robot"></i>
        <%= @is_new ? "Create Assistant" : "Edit Assistant" %>
      </h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><%= link_to "Testing", testing_root_path %></li>
          <li class="breadcrumb-item"><%= link_to "Assistants", testing_openai_assistants_path %></li>
          <% unless @is_new %>
            <li class="breadcrumb-item"><%= link_to @assistant.name, testing_openai_assistant_path(@assistant) %></li>
          <% end %>
          <li class="breadcrumb-item active">Playground</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Split-screen Playground -->
  <div class="assistant-playground"
       data-controller="assistant-playground"
       data-assistant-playground-assistant-id-value="<%= @assistant.assistant_id || '' %>"
       data-assistant-playground-is-new-value="<%= @is_new %>"
       data-assistant-playground-create-url-value="<%= @is_new ? create_assistant_testing_openai_assistant_playground_path(@assistant.id || 'new') : '' %>"
       data-assistant-playground-update-url-value="<%= @is_new ? '' : update_assistant_testing_openai_assistant_playground_path(@assistant.id) %>"
       data-assistant-playground-send-message-url-value="<%= @is_new ? '' : send_message_testing_openai_assistant_playground_path(@assistant.id) %>"
       data-assistant-playground-create-thread-url-value="<%= @is_new ? '' : create_thread_testing_openai_assistant_playground_path(@assistant.id) %>"
       data-assistant-playground-load-messages-url-value="<%= @is_new ? '' : load_messages_testing_openai_assistant_playground_path(@assistant.id) %>"
       data-assistant-playground-generate-instructions-url-value="<%= @is_new ? testing_openai_generate_assistant_instructions_path : generate_instructions_testing_openai_assistant_playground_path(@assistant.id) %>">

    <!-- Left Side: Configuration Sidebar -->
    <div class="playground-config">
      <!-- Basic Information -->
      <div class="card mb-3">
        <div class="card-header">
          <i class="bi bi-info-circle"></i> Basic Information
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Name <span class="text-danger">*</span></label>
            <input type="text"
                   class="form-control"
                   placeholder="e.g., Customer Support Assistant"
                   value="<%= @assistant.name %>"
                   data-assistant-playground-target="name"
                   required>
            <small class="form-text text-muted">A descriptive name for your assistant</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control"
                      rows="2"
                      placeholder="e.g., Helps customers with common support questions"
                      data-assistant-playground-target="description"><%= @assistant.description %></textarea>
            <small class="form-text text-muted">Optional description of what this assistant does</small>
          </div>
        </div>
      </div>

      <!-- System Instructions -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="bi bi-file-text"></i> System Instructions</span>
          <button type="button"
                  class="btn btn-sm btn-outline-primary"
                  data-action="click->assistant-playground#openGenerateModal">
            <i class="bi bi-stars"></i> Generate
          </button>
        </div>
        <div class="card-body">
          <textarea class="form-control font-monospace"
                    rows="8"
                    placeholder="You are a helpful assistant..."
                    data-assistant-playground-target="instructions"><%= @assistant.instructions %></textarea>
          <small class="form-text text-muted">
            Character count: <span data-assistant-playground-target="charCount">0</span>
          </small>
        </div>
      </div>

      <!-- Model Selection -->
      <div class="card mb-3">
        <div class="card-header">
          <i class="bi bi-cpu"></i> Model
        </div>
        <div class="card-body">
          <select class="form-select" data-assistant-playground-target="model">
            <% @available_models.each do |model| %>
              <option value="<%= model[:id] %>" <%= 'selected' if @assistant.model == model[:id] %>>
                <%= model[:name] %>
              </option>
            <% end %>
          </select>
        </div>
      </div>

      <!-- Tools -->
      <div class="card mb-3">
        <div class="card-header">
          <i class="bi bi-tools"></i> Tools
        </div>
        <div class="card-body">
          <%
            current_tools = @assistant.tools.map { |t| t["type"] } rescue []
          %>

          <!-- File Search -->
          <div class="form-check mb-2">
            <input class="form-check-input"
                   type="checkbox"
                   id="tool_file_search"
                   value="file_search"
                   data-assistant-playground-target="toolCheckbox"
                   <%= 'checked' if current_tools.include?('file_search') %>>
            <label class="form-check-label" for="tool_file_search">
              <i class="bi bi-search"></i> <strong>File Search</strong>
              <br>
              <small class="text-muted">Enables searching through uploaded files and documents</small>
            </label>
          </div>

          <!-- Code Interpreter -->
          <div class="form-check mb-2">
            <input class="form-check-input"
                   type="checkbox"
                   id="tool_code_interpreter"
                   value="code_interpreter"
                   data-assistant-playground-target="toolCheckbox"
                   <%= 'checked' if current_tools.include?('code_interpreter') %>>
            <label class="form-check-label" for="tool_code_interpreter">
              <i class="bi bi-code-slash"></i> <strong>Code Interpreter</strong>
              <br>
              <small class="text-muted">Enables Python code execution and data analysis</small>
            </label>
          </div>

          <hr class="my-3">

          <!-- Functions Section -->
          <div class="functions-section"
               data-controller="function-editor"
               data-assistant-playground-target="functionsSection"
               data-action="function-editor:changed->assistant-playground#handleFunctionsChanged function-editor:notification->assistant-playground#handleNotification">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0">
                <i class="bi bi-gear"></i> <strong>Functions</strong>
              </label>
              <button type="button"
                      class="btn btn-sm btn-outline-primary"
                      data-action="click->function-editor#addFunction">
                <i class="bi bi-plus"></i> Add
              </button>
            </div>
            <small class="text-muted d-block mb-2">Define custom functions for your assistant to call</small>

            <!-- Function List -->
            <div class="function-list" data-function-editor-target="functionList">
              <%
                # Extract functions from the assistant's tools array
                current_functions = (@assistant.tools || []).select { |t| t["type"] == "function" }.map { |t| t["function"] }
              %>
              <% if current_functions.empty? %>
                <div class="text-muted small text-center py-2 empty-functions-message">
                  <i class="bi bi-info-circle"></i> No functions defined
                </div>
              <% else %>
                <% current_functions.each_with_index do |func, index| %>
                  <%
                    # Prepare function data for JS - convert to proper format
                    func_data = {
                      name: func["name"],
                      description: func["description"],
                      parameters: func["parameters"],
                      strict: func["strict"] || false
                    }
                    # Use ERB's built-in HTML escaping for proper attribute encoding
                    func_data_json = func_data.to_json
                  %>
                  <div class="function-item card mb-2" data-function-index="<%= index %>" data-function-data="<%= ERB::Util.html_escape(func_data_json) %>">
                    <div class="card-body py-2 px-3">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="function-info flex-grow-1">
                          <strong class="function-name"><%= func["name"] %></strong>
                          <br>
                          <small class="text-muted function-description"><%= func["description"]&.truncate(60) %></small>
                          <% param_count = func.dig("parameters", "properties")&.keys&.length || 0 %>
                          <% if param_count > 0 %>
                            <br><small class="text-muted"><i class="bi bi-box"></i> <%= param_count %> parameter<%= param_count == 1 ? '' : 's' %></small>
                          <% end %>
                        </div>
                        <div class="function-actions btn-group btn-group-sm">
                          <button type="button"
                                  class="btn btn-outline-secondary"
                                  data-action="click->function-editor#editFunction"
                                  data-function-index="<%= index %>"
                                  title="Edit">
                            <i class="bi bi-pencil"></i>
                          </button>
                          <button type="button"
                                  class="btn btn-outline-danger"
                                  data-action="click->function-editor#deleteFunction"
                                  data-function-index="<%= index %>"
                                  title="Delete">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Files & Vector Stores (for file_search tool) -->
      <%= render "prompt_tracker/testing/openai/assistant_playground/file_management" %>

      <!-- Model Configuration (Collapsible) -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="bi bi-sliders"></i> Model Configuration</span>
          <button class="btn btn-sm btn-link"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#modelConfig">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
        <div id="modelConfig" class="collapse card-body">
          <!-- Response Format -->
          <div class="mb-3">
            <label class="form-label">Response Format</label>
            <select class="form-select" data-assistant-playground-target="responseFormat">
              <%
                # response_format can be a string ("auto", "text") or a hash ({"type": "json_object"})
                response_format = @assistant.metadata&.[]("response_format")
                current_format = if response_format.is_a?(Hash)
                  response_format["type"] || "auto"
                else
                  response_format || "auto"
                end
              %>
              <option value="auto" <%= 'selected' if current_format == 'auto' %>>Auto</option>
              <option value="text" <%= 'selected' if current_format == 'text' %>>Text</option>
              <option value="json_object" <%= 'selected' if current_format == 'json_object' %>>JSON Object</option>
            </select>
            <small class="form-text text-muted">Format of the assistant's responses</small>
          </div>

          <!-- Temperature -->
          <div class="mb-3">
            <label class="form-label">
              Temperature: <span data-assistant-playground-target="temperatureValue"><%= @assistant.metadata&.dig("temperature") || 1.0 %></span>
            </label>
            <input type="range"
                   class="form-range"
                   min="0"
                   max="2"
                   step="0.1"
                   value="<%= @assistant.metadata&.dig("temperature") || 1.0 %>"
                   data-assistant-playground-target="temperature">
            <small class="form-text text-muted">Controls randomness (0 = focused, 2 = creative)</small>
          </div>

          <!-- Top P -->
          <div class="mb-3">
            <label class="form-label">
              Top P: <span data-assistant-playground-target="topPValue"><%= @assistant.metadata&.dig("top_p") || 1.0 %></span>
            </label>
            <input type="range"
                   class="form-range"
                   min="0"
                   max="1"
                   step="0.05"
                   value="<%= @assistant.metadata&.dig("top_p") || 1.0 %>"
                   data-assistant-playground-target="topP">
            <small class="form-text text-muted">Nucleus sampling threshold</small>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="d-grid gap-2">
        <button type="button"
                class="btn btn-primary"
                data-action="click->assistant-playground#saveAssistant"
                data-assistant-playground-target="saveButton">
          <i class="bi bi-save"></i>
          <span data-assistant-playground-target="saveButtonText">
            <%= @is_new ? "Create Assistant" : "Update Assistant" %>
          </span>
        </button>

        <%= link_to testing_openai_assistants_path, class: "btn btn-outline-secondary" do %>
          <i class="bi bi-arrow-left"></i> Back to Assistants
        <% end %>

        <div class="text-muted small text-center" data-assistant-playground-target="saveStatus">
          <i class="bi bi-clock"></i> <%= @is_new ? "Not saved" : "Saved" %>
        </div>
      </div>
    </div>

    <!-- Right Side: Thread Chat Interface -->
    <div class="playground-thread">
      <!-- Thread Header -->
      <div class="thread-header">
        <h5><i class="bi bi-chat-dots"></i> Test Conversation</h5>
        <div class="thread-actions">
          <% unless @is_new %>
            <button class="btn btn-sm btn-outline-primary"
                    data-action="click->assistant-playground#createNewThread"
                    data-assistant-playground-target="newThreadButton">
              <i class="bi bi-plus-circle"></i> New Thread
            </button>
          <% end %>
          <span class="badge bg-secondary" data-assistant-playground-target="threadId">
            No thread
          </span>
        </div>
      </div>

      <!-- Messages Container -->
      <div class="messages-container" data-assistant-playground-target="messagesContainer">
        <% if @is_new %>
          <div class="text-center text-muted py-5">
            <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
            <p class="mt-3">Save the assistant first to start testing</p>
          </div>
        <% else %>
          <div class="text-center text-muted py-5">
            <i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
            <p class="mt-3">Start a conversation to test your assistant</p>
          </div>
        <% end %>

        <!-- Loading Indicator (hidden by default) -->
        <div class="message assistant-message loading" style="display: none;">
          <div class="message-avatar">
            <i class="bi bi-robot"></i>
          </div>
          <div class="message-content">
            <div class="typing-indicator">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Message Input -->
      <div class="message-input-container">
        <form data-action="submit->assistant-playground#sendMessage">
          <div class="input-group">
            <textarea class="form-control"
                      rows="2"
                      placeholder="<%= @is_new ? 'Save the assistant first...' : 'Type your message...' %>"
                      data-assistant-playground-target="messageInput"
                      <%= 'disabled' if @is_new %>
                      required></textarea>
            <button type="submit"
                    class="btn btn-primary"
                    data-assistant-playground-target="sendButton"
                    <%= 'disabled' if @is_new %>>
              <i class="bi bi-send"></i> Send
            </button>
          </div>
          <small class="text-muted">
            Press Enter to send, Shift+Enter for new line
          </small>
        </form>
      </div>
    </div>

    <!-- Toast Container for Notifications (inside controller scope) -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="assistantToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" data-assistant-playground-target="toast">
    <div class="d-flex">
      <div class="toast-body" data-assistant-playground-target="toastBody">
        <!-- Message will be inserted here -->
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Generate Instructions Modals (moved to body via modal-fix for proper z-index) -->
<div data-controller="modal-fix">
  <%= render "prompt_tracker/testing/openai/assistant_playground/generate_instructions_modal" %>
  <%= render "prompt_tracker/testing/openai/assistant_playground/generating_instructions_modal" %>
</div>

<!-- Function Editor Modal (moved to body via modal-fix for proper z-index) -->
<div data-controller="modal-fix">
<div class="modal fade" id="functionEditorModal" tabindex="-1" aria-labelledby="functionEditorModalLabel" aria-hidden="true" data-modal-fix-target="modal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="functionEditorModalLabel">
          <i class="bi bi-gear"></i>
          <span id="functionModalTitle">Add Function</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="functionEditIndex" value="-1">

        <div class="mb-3">
          <label class="form-label" for="functionName">Function Name <span class="text-danger">*</span></label>
          <input type="text"
                 id="functionName"
                 class="form-control font-monospace"
                 placeholder="e.g., get_weather"
                 pattern="^[a-zA-Z_][a-zA-Z0-9_]*$"
                 required>
          <small class="form-text text-muted">Must start with a letter or underscore, alphanumeric characters only</small>
        </div>

        <div class="mb-3">
          <label class="form-label" for="functionDescription">Description <span class="text-danger">*</span></label>
          <textarea id="functionDescription"
                    class="form-control"
                    rows="2"
                    placeholder="e.g., Get the current weather for a given location"
                    required></textarea>
          <small class="form-text text-muted">Describe what the function does so the assistant knows when to use it</small>
        </div>

        <div class="mb-3">
          <label class="form-label" for="functionParameters">
            Parameters (JSON Schema) <span class="text-danger">*</span>
            <a class="ms-2 text-decoration-none small" data-bs-toggle="collapse" href="#parameterSchemaHelp" role="button" aria-expanded="false" aria-controls="parameterSchemaHelp">
              <i class="bi bi-question-circle"></i> Help
            </a>
          </label>

          <!-- Collapsible Help Section -->
          <div class="collapse mb-2" id="parameterSchemaHelp">
            <div class="card card-body bg-light small">
              <h6 class="mb-2"><i class="bi bi-book"></i> JSON Schema Reference</h6>

              <p class="mb-2">Define your function's parameters using <a href="https://json-schema.org/" target="_blank">JSON Schema</a> format.</p>

              <table class="table table-sm table-bordered mb-3">
                <thead class="table-secondary">
                  <tr>
                    <th>Key</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><code>type</code></td>
                    <td>Must be <code>"object"</code> at the root level</td>
                  </tr>
                  <tr>
                    <td><code>properties</code></td>
                    <td>Object containing parameter definitions</td>
                  </tr>
                  <tr>
                    <td><code>required</code></td>
                    <td>Array of required parameter names</td>
                  </tr>
                  <tr>
                    <td><code>additionalProperties</code></td>
                    <td>Set to <code>false</code> to disallow extra properties (required for strict mode)</td>
                  </tr>
                </tbody>
              </table>

              <h6 class="mb-2">Property Types</h6>
              <table class="table table-sm table-bordered mb-3">
                <thead class="table-secondary">
                  <tr>
                    <th>Type</th>
                    <th>Example</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><code>string</code></td>
                    <td><code>{"type": "string", "description": "User's name"}</code></td>
                  </tr>
                  <tr>
                    <td><code>number</code></td>
                    <td><code>{"type": "number", "description": "Temperature in Celsius"}</code></td>
                  </tr>
                  <tr>
                    <td><code>integer</code></td>
                    <td><code>{"type": "integer", "description": "Number of items"}</code></td>
                  </tr>
                  <tr>
                    <td><code>boolean</code></td>
                    <td><code>{"type": "boolean", "description": "Enable feature"}</code></td>
                  </tr>
                  <tr>
                    <td><code>array</code></td>
                    <td><code>{"type": "array", "items": {"type": "string"}}</code></td>
                  </tr>
                  <tr>
                    <td><code>enum</code></td>
                    <td><code>{"type": "string", "enum": ["small", "medium", "large"]}</code></td>
                  </tr>
                </tbody>
              </table>

              <h6 class="mb-2"><i class="bi bi-code-square"></i> Complete Example</h6>
              <pre class="bg-dark text-light p-2 rounded mb-0" style="font-size: 0.75rem;">{
  "type": "object",
  "properties": {
    "location": {
      "type": "string",
      "description": "City and state, e.g. San Francisco, CA"
    },
    "unit": {
      "type": "string",
      "enum": ["celsius", "fahrenheit"],
      "description": "Temperature unit"
    },
    "days": {
      "type": "integer",
      "description": "Number of days to forecast"
    }
  },
  "required": ["location"],
  "additionalProperties": false
}</pre>
            </div>
          </div>

          <textarea id="functionParameters"
                    class="form-control font-monospace"
                    rows="10"
                    placeholder='{
  "type": "object",
  "properties": {
    "location": {
      "type": "string",
      "description": "The city and state, e.g. San Francisco, CA"
    }
  },
  "required": ["location"]
}'
                    required></textarea>
          <small class="form-text text-muted">JSON Schema defining the function's parameters. Must be a valid object schema.</small>
          <div id="functionParametersError" class="invalid-feedback">
            Invalid JSON
          </div>
        </div>

        <div class="form-check">
          <input class="form-check-input"
                 type="checkbox"
                 id="functionStrict">
          <label class="form-check-label" for="functionStrict">
            <strong>Strict Mode</strong>
            <br>
            <small class="text-muted">Enable strict schema adherence (recommended for production)</small>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button"
                class="btn btn-primary"
                data-action="click->function-editor#saveFunction">
          <i class="bi bi-check"></i>
          <span id="functionSaveButtonText">Add Function</span>
        </button>
      </div>
    </div>
  </div>
</div>
</div>

  </div>
</div>
