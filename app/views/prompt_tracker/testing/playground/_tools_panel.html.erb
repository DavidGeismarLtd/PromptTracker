<%#
  Tools Panel
  Shown when any API supports tools (Chat Completions, Responses, Assistants, etc.)

  Local variables:
    - available_tools: Array of tool hashes from Configuration#tools_for_api
    - enabled_tools: Hash with tool configs (e.g., {"web_search" => true, "file_search" => {"vector_store_ids" => [...]}})
    - tool_config: Hash with detailed tool configuration (file_search vector_store_ids, functions array)
%>

<%
  available_tools ||= []
  # Handle both array format (legacy) and hash format (new)
  if enabled_tools.is_a?(Array)
    enabled_tools_hash = enabled_tools.each_with_object({}) { |t, h| h[t.to_s] = true }
  else
    enabled_tools_hash = enabled_tools || {}
  end
  tool_config ||= @version&.model_config&.dig('tool_config') || {}
%>

<style>
  .tool-card {
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    border: 2px solid transparent;
  }
  .tool-card:hover {
    border-color: var(--bs-primary);
    background-color: var(--bs-light);
  }
  .tool-card.active {
    border-color: var(--bs-primary);
    background-color: rgba(var(--bs-primary-rgb), 0.1);
  }
  .tool-card .tool-icon {
    font-size: 1.25rem;
    opacity: 0.6;
    transition: opacity 0.15s ease-in-out;
  }
  .tool-card.active .tool-icon {
    opacity: 1;
    color: var(--bs-primary);
  }
  .tool-card .check-indicator {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    color: var(--bs-primary);
    transition: opacity 0.15s ease-in-out;
  }
  .tool-card.active .check-indicator {
    opacity: 1;
  }
  .tool-config-panel {
    display: none;
    animation: slideDown 0.2s ease-out;
  }
  .tool-config-panel.show {
    display: block;
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="tools-panel mt-3"
     data-controller="tools-config"
     data-playground-target="toolsPanel">
  <label class="form-label">
    <i class="bi bi-tools"></i> Tools
    <span class="badge bg-info ms-1">Beta</span>
  </label>
  <div class="form-text mb-2">
    Enable tools for this API. These tools allow the model to search the web,
    analyze files, execute code, and call custom functions.
  </div>

  <div class="row g-2" data-playground-target="toolsPanelContent">
    <% available_tools.each do |tool| %>
      <%
        is_enabled = enabled_tools_hash[tool[:id].to_s].present?
        card_class = is_enabled ? 'active' : ''
        is_configurable = tool[:configurable] == true
      %>
      <div class="col-md-3">
        <label class="card tool-card p-3 h-100 position-relative <%= card_class %>"
               for="tool_<%= tool[:id] %>"
               data-action="click->playground#onToolCardClick">
          <input class="d-none"
                 type="checkbox"
                 id="tool_<%= tool[:id] %>"
                 value="<%= tool[:id] %>"
                 data-playground-target="toolCheckbox"
                 data-tools-config-target="toolCheckbox"
                 data-tool-id="<%= tool[:id] %>"
                 data-configurable="<%= is_configurable %>"
                 data-action="change->playground#onToolChange change->tools-config#onToolToggle"
                 <%= 'checked' if is_enabled %>>
          <i class="bi bi-check-circle-fill check-indicator"></i>
          <div class="text-center">
            <i class="bi <%= tool[:icon] %> tool-icon d-block mb-2"></i>
            <strong class="d-block" style="font-size: 0.85rem;"><%= tool[:name] %></strong>
            <small class="text-muted" style="font-size: 0.7rem;"><%= tool[:description] %></small>
          </div>
        </label>
      </div>
    <% end %>
  </div>

  <%# File Search Configuration Panel %>
  <% file_search_config = tool_config.dig('file_search') || {} %>
  <%= render 'prompt_tracker/testing/playground/tools/file_search_configuration_panel',
             file_search_config: file_search_config,
             enabled_tools_hash: enabled_tools_hash,
             tool_config: tool_config %>

  <%# Create Vector Store Modal - will be moved to body by JS for z-index fix %>
  <%= render 'prompt_tracker/testing/playground/tools/create_vector_store_modal' %>

  <%# Vector Store Files Modal - shows files in a selected vector store %>
  <%= render 'prompt_tracker/testing/playground/tools/vector_store_files_modal' %>

  <%# Functions Configuration Panel %>
  <% functions_config = tool_config.dig('functions') || [] %>
  <%= render 'prompt_tracker/testing/playground/tools/functions_configuration_panel',
             functions_config: functions_config,
             enabled_tools_hash: enabled_tools_hash,
             tool_config: tool_config %>

  <% if available_tools.empty? %>
    <div class="alert alert-secondary py-2" data-playground-target="noToolsAlert">
      <i class="bi bi-info-circle"></i>
      No tools available for this API.
    </div>
  <% end %>
</div>
