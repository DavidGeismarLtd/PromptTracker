<%# Rendered prompt cell - clickable to open modal with highlighted variables %>
<td data-column="rendered_prompt">
  <% rendered_prompt = run.rendered_prompt %>
  <% variables_used = run.variables_used %>

  <% if rendered_prompt.present? %>
    <% modal_id = "rendered-prompt-modal-#{run.id}" %>

    <!-- Clickable cell content -->
    <div style="cursor: pointer;"
         data-bs-toggle="modal"
         data-bs-target="#<%= modal_id %>">
      <small class="text-muted"><%= truncate(rendered_prompt, length: 100) %></small>
      <% if rendered_prompt.length > 100 %>
        <i class="bi bi-three-dots text-primary ms-1"></i>
      <% end %>
    </div>

    <!-- Modal wrapped in modal-fix controller parent -->
    <div data-controller="modal-fix">
      <div class="modal fade"
           id="<%= modal_id %>"
           tabindex="-1"
           aria-labelledby="<%= modal_id %>-label"
           aria-hidden="true"
           data-modal-fix-target="modal">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="<%= modal_id %>-label">
                <i class="bi bi-file-text"></i> Rendered Prompt
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;">
                <%= highlight_variables(rendered_prompt, variables_used) %>
              </div>
              <% if variables_used.present? && variables_used.any? %>
                <hr>
                <div class="small">
                  <strong class="text-muted">Variables used:</strong>
                  <div class="mt-2">
                    <% variables_used.each do |key, value| %>
                      <div class="mb-2 d-flex align-items-start">
                        <span class="badge bg-warning text-dark me-2" style="min-width: fit-content;"><%= key %></span>
                        <span class="text-muted" style="word-break: break-word;"><%= truncate(value.to_s, length: 200) %></span>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <span class="text-muted">-</span>
  <% end %>
</td>
