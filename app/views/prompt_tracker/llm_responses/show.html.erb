<% content_for :breadcrumbs do %>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
      <li class="breadcrumb-item"><%= link_to @prompt.name, prompt_path(@prompt) %></li>
      <li class="breadcrumb-item"><%= link_to "v#{@version.version_number}", prompt_prompt_version_path(@prompt, @version) %></li>
      <li class="breadcrumb-item active" aria-current="page">Response #<%= @response.id %></li>
    </ol>
  </nav>
<% end %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="bi bi-chat-left-text"></i>
    LLM Response #<%= @response.id %>
  </h1>
  <%= link_to prompt_prompt_version_path(@prompt, @version), class: "btn btn-outline-secondary" do %>
    <i class="bi bi-arrow-left"></i> Back to Version
  <% end %>
</div>

<!-- Response Details Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Response Details</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <table class="table table-sm">
          <tbody>
            <tr>
              <th style="width: 40%;">ID</th>
              <td><code>#<%= @response.id %></code></td>
            </tr>
            <tr>
              <th>Prompt</th>
              <td><%= link_to @prompt.name, prompt_path(@prompt) %></td>
            </tr>
            <tr>
              <th>Version</th>
              <td><%= link_to "v#{@version.version_number}", prompt_prompt_version_path(@prompt, @version) %></td>
            </tr>
            <tr>
              <th>Provider</th>
              <td><%= provider_icon(@response.provider) %> <%= @response.provider %></td>
            </tr>
            <tr>
              <th>Model</th>
              <td><code><%= @response.model %></code></td>
            </tr>
            <tr>
              <th>Status</th>
              <td><%= status_badge(@response.status) %></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col-md-6">
        <table class="table table-sm">
          <tbody>
            <tr>
              <th style="width: 40%;">Response Time</th>
              <td><%= format_duration(@response.response_time_ms) %></td>
            </tr>
            <tr>
              <th>Tokens (Prompt)</th>
              <td><%= format_tokens(@response.tokens_prompt) %></td>
            </tr>
            <tr>
              <th>Tokens (Completion)</th>
              <td><%= format_tokens(@response.tokens_completion) %></td>
            </tr>
            <tr>
              <th>Tokens (Total)</th>
              <td><strong><%= format_tokens(@response.tokens_total) %></strong></td>
            </tr>
            <tr>
              <th>Cost</th>
              <td><strong><%= format_cost(@response.cost_usd) %></strong></td>
            </tr>
            <tr>
              <th>Created</th>
              <td><%= format_timestamp(@response.created_at) %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <% if @response.user_id || @response.session_id || @response.environment %>
      <hr>
      <h6><i class="bi bi-tag"></i> Context</h6>
      <table class="table table-sm">
        <tbody>
          <% if @response.user_id %>
            <tr>
              <th style="width: 20%;">User ID</th>
              <td><code><%= @response.user_id %></code></td>
            </tr>
          <% end %>
          <% if @response.session_id %>
            <tr>
              <th>Session ID</th>
              <td><code><%= @response.session_id %></code></td>
            </tr>
          <% end %>
          <% if @response.environment %>
            <tr>
              <th>Environment</th>
              <td><span class="badge bg-info"><%= @response.environment %></span></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>

<!-- Rendered Prompt Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-file-text"></i> Rendered Prompt</h5>
  </div>
  <div class="card-body">
    <% if @response.variables_used.present? %>
      <h6>Variables Used:</h6>
      <pre class="bg-light p-3 rounded"><%= JSON.pretty_generate(@response.variables_used) %></pre>
    <% end %>

    <h6 class="mt-3">Final Prompt Sent to LLM:</h6>
    <div class="bg-light p-3 rounded" style="white-space: pre-wrap; font-family: monospace;"><%= @response.rendered_prompt %></div>
  </div>
</div>

<!-- Response Text Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-chat-right-text"></i> LLM Response</h5>
  </div>
  <div class="card-body">
    <% if @response.status == "success" && @response.response_text.present? %>
      <div class="bg-light p-3 rounded" style="white-space: pre-wrap;"><%= @response.response_text %></div>

      <% if @response.response_metadata.present? %>
        <hr>
        <h6>Response Metadata:</h6>
        <pre class="bg-light p-3 rounded"><%= JSON.pretty_generate(@response.response_metadata) %></pre>
      <% end %>
    <% elsif @response.status == "error" || @response.status == "timeout" %>
      <div class="alert alert-danger">
        <h6><i class="bi bi-exclamation-triangle"></i> <%= @response.error_type || "Error" %></h6>
        <p class="mb-0"><%= @response.error_message %></p>
      </div>
    <% else %>
      <div class="alert alert-warning">
        <i class="bi bi-hourglass"></i> Response pending or no response text available.
      </div>
    <% end %>
  </div>
</div>

<!-- Evaluations Card -->
<% if @evaluations.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-star"></i> Evaluations (<%= @evaluations.count %>)</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Type</th>
              <th>Evaluator</th>
              <th>Score</th>
              <th>Normalized Score</th>
              <th>Feedback</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            <% @evaluations.each do |evaluation| %>
              <tr>
                <td><%= status_badge(evaluation.evaluator_type) %></td>
                <td><code><%= evaluation.evaluator_id || 'N/A' %></code></td>
                <td>
                  <strong><%= evaluation.score %></strong>
                  <% if evaluation.score_min && evaluation.score_max %>
                    <small class="text-muted">(range: <%= evaluation.score_min %>-<%= evaluation.score_max %>)</small>
                  <% end %>
                </td>
                <td>
                  <% normalized = PromptTracker::EvaluationHelpers.normalize_score(evaluation.score, min: evaluation.score_min, max: evaluation.score_max) %>
                  <%= score_badge(normalized * 100, 0, 100) %>
                </td>
                <td>
                  <% if evaluation.feedback.present? %>
                    <small><%= truncate(evaluation.feedback, length: 100) %></small>
                  <% else %>
                    <span class="text-muted">â€”</span>
                  <% end %>
                </td>
                <td><%= format_relative_time(evaluation.created_at) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% else %>
  <div class="card mb-4">
    <div class="card-body text-center text-muted">
      <i class="bi bi-star" style="font-size: 3rem;"></i>
      <p class="mt-3">No evaluations yet for this response.</p>
    </div>
  </div>
<% end %>

<!-- Additional Context Card -->
<% if @response.context.present? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-code-square"></i> Additional Context</h5>
    </div>
    <div class="card-body">
      <pre class="bg-light p-3 rounded"><%= JSON.pretty_generate(@response.context) %></pre>
    </div>
  </div>
<% end %>

<!-- Create Evaluation Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#evaluationForm" aria-expanded="false" aria-controls="evaluationForm">
        <i class="bi bi-plus-circle"></i> Add New Evaluation
        <i class="bi bi-chevron-down float-end"></i>
      </button>
    </h5>
  </div>
  <div class="collapse" id="evaluationForm">
    <div class="card-body">
      <%= form_with model: PromptTracker::Evaluation.new, url: evaluations_path, method: :post, local: true do |f| %>
        <%= f.hidden_field :llm_response_id, value: @response.id %>

        <div class="row">
          <!-- Evaluator Type -->
          <div class="col-md-6 mb-3">
            <%= f.label :evaluator_type, "Evaluator Type", class: "form-label" %>
            <%= f.select :evaluator_type,
                         options_for_select([
                           ['Human', 'human'],
                           ['Automated', 'automated'],
                           ['LLM Judge', 'llm_judge']
                         ], 'human'),
                         {},
                         class: "form-select" %>
            <small class="form-text text-muted">Who or what is performing this evaluation?</small>
          </div>

          <!-- Evaluator ID -->
          <div class="col-md-6 mb-3">
            <%= f.label :evaluator_id, "Evaluator ID", class: "form-label" %>
            <%= f.text_field :evaluator_id,
                            class: "form-control",
                            placeholder: "e.g., john@example.com or gpt-4" %>
            <small class="form-text text-muted">Email for humans, model name for LLM judges, system name for automated</small>
          </div>
        </div>

        <div class="row">
          <!-- Score -->
          <div class="col-md-4 mb-3">
            <%= f.label :score, "Score", class: "form-label" %>
            <%= f.number_field :score,
                              class: "form-control",
                              step: 0.1,
                              min: 0,
                              max: 5,
                              value: 3,
                              required: true %>
          </div>

          <!-- Score Min -->
          <div class="col-md-4 mb-3">
            <%= f.label :score_min, "Min Score", class: "form-label" %>
            <%= f.number_field :score_min,
                              class: "form-control",
                              step: 0.1,
                              value: 0,
                              required: true %>
          </div>

          <!-- Score Max -->
          <div class="col-md-4 mb-3">
            <%= f.label :score_max, "Max Score", class: "form-label" %>
            <%= f.number_field :score_max,
                              class: "form-control",
                              step: 0.1,
                              value: 5,
                              required: true %>
          </div>
        </div>

        <!-- Score Range Display -->
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">Score Range:</small>
            <input type="range" class="form-range" id="scoreRange" min="0" max="5" step="0.1" value="3">
            <span class="badge bg-primary ms-2" id="scoreDisplay">3.0</span>
          </div>
        </div>

        <!-- Feedback -->
        <div class="mb-3">
          <%= f.label :feedback, "Feedback (Optional)", class: "form-label" %>
          <%= f.text_area :feedback,
                         class: "form-control",
                         rows: 4,
                         placeholder: "Provide detailed feedback about this response..." %>
          <small class="form-text text-muted">Any comments or observations about the quality of this response</small>
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex gap-2">
          <%= f.submit "Create Evaluation", class: "btn btn-primary" %>
          <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#evaluationForm">Cancel</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Sync the range slider with the score input field
  document.addEventListener('DOMContentLoaded', function() {
    const scoreInput = document.querySelector('input[name="evaluation[score]"]');
    const scoreRange = document.getElementById('scoreRange');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const scoreMin = document.querySelector('input[name="evaluation[score_min]"]');
    const scoreMax = document.querySelector('input[name="evaluation[score_max]"]');

    function updateRange() {
      if (scoreMin && scoreMax && scoreRange) {
        scoreRange.min = scoreMin.value;
        scoreRange.max = scoreMax.value;
        scoreRange.value = scoreInput.value;
      }
    }

    function updateScore(value) {
      scoreInput.value = value;
      scoreDisplay.textContent = parseFloat(value).toFixed(1);
    }

    if (scoreRange && scoreInput && scoreDisplay) {
      // Update score when range slider changes
      scoreRange.addEventListener('input', function() {
        updateScore(this.value);
      });

      // Update range when score input changes
      scoreInput.addEventListener('input', function() {
        scoreRange.value = this.value;
        scoreDisplay.textContent = parseFloat(this.value).toFixed(1);
      });

      // Update range limits when min/max changes
      if (scoreMin) {
        scoreMin.addEventListener('input', updateRange);
      }
      if (scoreMax) {
        scoreMax.addEventListener('input', updateRange);
      }

      // Initialize
      updateRange();
      scoreDisplay.textContent = parseFloat(scoreInput.value).toFixed(1);
    }
  });
</script>
